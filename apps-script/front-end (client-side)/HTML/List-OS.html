<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--INCLUDE REQUIRED EXTERNAL JAVASCRIPT AND CSS LIBRARIES-->
    
    <!-- jQuery UI -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">

    <!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script> -->
   

    <!-- Date Range Picker -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <!-- Bootstrap CSS -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous"> -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">

    <!-- fontawesome -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Bootstrap-select -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/css/bootstrap-select.min.css"> -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">

    <!-- Select2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <!-- Or for RTL support -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.rtl.min.css" />

    <!-- DataTables -->
    <link href="https://cdn.datatables.net/v/bs5/dt-2.1.3/sl-2.0.4/datatables.min.css" rel="stylesheet">
    <!-- <link href="https://cdn.datatables.net/v/dt/dt-2.1.3/sl-2.0.4/datatables.min.css" rel="stylesheet"> -->
    <link href="https://cdn.datatables.net/fixedcolumns/5.0.1/css/fixedColumns.bootstrap5.css" rel="stylesheet">

    <!-- bootstrap icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link href='https://fonts.googleapis.com/css?family=Quattrocento Sans' rel='stylesheet'>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
 
    <?!= include('[CSS]Style'); ?> <!--INCLUDE [CSS]Style.html FILE-->
    
  </head>
 
  <body>
    {{NAV_SIDEBAR}}

    <!-- Navigation bar -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
      <div class="nav-body">

        <!-- Page Title -->
        <div class="page-title"><span class="rfq-type-tag">OS</span> RFQ List</div>

      </div>
    </nav>

    <iframe name="hidden-iframe" style="position: absolute; visibility: hidden" sandbox="allow-top-navigation allow-scripts allow-forms allow-same-origin allow-popups"></iframe><!-- sandbox="allow-top-navigation allow-scripts allow-forms allow-same-origin" -->
    <!-- use for Live Link V2 -->
    <form id="rfqStatusForm" onsubmit="handleFormSubmit(this)" method="POST" action="https://script.google.com/macros/s/AKfycbzR4C6JvphST5AY-i8Gzpv1ECapoC0pwl4Xyv8qx4i2Mv8sIO8chVT4fKumq_VCIVr4/exec" target="hidden-iframe">
      <input type="hidden" name="RFQ ID" id="rfqId">
      <input type="hidden" name="RFQ Status" id="rfqStatus">
      <input type="hidden" name="Notes" id="rfqComments">
      <input type="hidden" name="Output URL" id="rfqOutputURL">
      <input type="hidden" name="Last submit type" id="formType" value="update-status">
      <input type="hidden" name="RFQ type" id="rfqType" value="OS">
    </form>

    <!-- Main body -->
    <div class="main-body">
      <div class="row">
        <div class="card shadow-sm" style="height: calc(100vh - 100px);max-height: calc(100vh - 100px);">
          <div class="card-body" style="height:100%;">
            <div class="go-to-btn-container d-none" style="display:inline-block;"><a class="btn btn-outline-secondary btn-sm go-to-btn"
                      href="https://docs.google.com/spreadsheets/d/1pWFTXnpKhO6VOzHT7KsjrUPxmKFwfQdlatTKmWvTjUk/edit?gid=36461421#gid=36461421"
                      target="_blank" data-bs-toggle="tooltip" data-bs-placement="top" title="Open OS RFQ List" role="button"><i
                        class="bi bi-box-arrow-up-right"></i></a>
            </div>
            <div id="selectDateRange" class="form-control form-control-sm d-none">
                <div style="display:flex;align-items:center;">
                  <i class="bi bi-calendar4" style="display:flex;align-items:center;"></i>&nbsp;&nbsp;
                  <span style="align-self:center;"></span>
                </div>
                <div style="display:flex;align-items:center;text-align:right;margin-left:auto;">
                  <i class="bi bi-chevron-down" style="display:flex;align-items:center;"></i>
                </div>
            </div>
            <div class="dropdown filter-dropdown d-none" style="display: inline-block;">
              <button type="button" id="showFilterDropdown" class="btn btn-outline-secondary btn-sm" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                <i class="bi bi-filter" style="display: flex;align-items: center;"></i> Filters 
                <span class="filter-cnt-total">0</span>
              </button>
              <div class="dropdown-menu p-2 filter-dropdown-menu">
                <div>
                  <div class="filter-header">
                    <label for="filterSelect">Filters</label>
                    <button id="clearFilter" class="btn btn-light btn-sm" style="background-color:white;position:relative;">
                      <i class="fa fa-refresh" style="font-size:11px;" aria-hidden="true"></i>
                    </button>
                  </div>
                    
                  <div class="accordion accordion-flush" id="filterAccordion">
                      <!-- Status Accordion -->
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="headingStatus">
                          <button
                            class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseStatus"
                            aria-expanded="true"
                            aria-controls="collapseStatus"
                          >
                          Status <span class="filter-cnt-subtotal filter-cnt-status">0</span>
                          </button>
                        </h2>
                        <div
                          id="collapseStatus"
                          class="accordion-collapse collapse"
                          aria-labelledby="headingStatus"
                        >
                          <div class="accordion-body">
                            <input
                              type="search"
                              id="statusSearch"
                              class="form-control form-control-sm mb-2"
                              placeholder="Search status"
                            />
                            <div id="statusFilters" class="form-check filter-list">
                              <!-- Checkboxes will be dynamically populated -->
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- Owner Accordion -->
                      <div class="accordion-item">
                          <h2 class="accordion-header" id="headingOwner">
                            <button
                              class="accordion-button collapsed"
                              type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#collapseOwner"
                              aria-expanded="true"
                              aria-controls="collapseOwner"
                            >
                            Owner <span class="filter-cnt-subtotal filter-cnt-owner">0</span>
                            </button>
                          </h2>
                          <div
                            id="collapseOwner"
                            class="accordion-collapse collapse"
                            aria-labelledby="headingOwner"
                          >
                            <div class="accordion-body">
                              <input
                                type="search"
                                id="ownerSearch"
                                class="form-control form-control-sm mb-2"
                                placeholder="Search owner"
                              />
                              <div id="ownerFilters" class="form-check filter-list">
                                <!-- Checkboxes will be dynamically populated -->
                              </div>
                            </div>
                          </div>
                      </div>
                      <!-- Client Accordion -->
                      <div class="accordion-item">
                          <h2 class="accordion-header" id="headingClient">
                            <button
                              class="accordion-button collapsed"
                              type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#collapseClient"
                              aria-expanded="true"
                              aria-controls="collapseClient"
                            >
                            Client <span class="filter-cnt-subtotal filter-cnt-client">0</span>
                            </button>
                          </h2>
                          <div
                            id="collapseClient"
                            class="accordion-collapse collapse"
                            aria-labelledby="headingClient"
                          >
                            <div class="accordion-body">
                              <input
                                type="search"
                                id="clientSearch"
                                class="form-control form-control-sm mb-2"
                                placeholder="Search client"
                              />
                              <div id="clientFilters" class="form-check filter-list">
                                <!-- Checkboxes will be dynamically populated -->
                              </div>
                            </div>
                          </div>
                      </div>
                  </div>
                </div>
              </div>
            </div>
            <table id="rfqListTable" class="table table-sm nowrap" width="100%">
              <thead>
              </thead>
              <tbody style="font-size:13px;">
              </tbody>
            </table>
            <div class="table-loading-spinner-container" style="height:100%;display:flex;align-items:center;justify-content:center;">
              <span class="spinner table-loading-spinner spinner-border spinner-border-sm spinner-busy" role="status" style="width: 2rem;height: 2rem;color: #475562;" aria-hidden="true"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- offCanvas -->
    <div class="offcanvas offcanvas-end" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasRightLabel">RFQ #<span id="offCanvasInsertRFQId"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <h6>Summary 
          <button id="copyCRMProject" class="btn btn-sm copy-crm-info" data-bs-toggle="tooltip" data-bs-placement="right" title="Copy Info" type="button"><i class="bi bi-copy"></i></button>
        </h6>
        <table class="offcanvas-details-table table-sm">
          <tbody style="font-size:13px;">
            <tr>
              <th width="40%">Status</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>RFQ Date</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Owner</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Countries</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Client</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Client name</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Project name</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Targeting condition</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Project type</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Total sales</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Total GM</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Total GM (%)</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Output URL</th>
              <td class="position-relative">
                
              </td>
            </tr>
            <tr>
              <th>Notes</th>
              <td class="position-relative">
                
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="offcanvas-footer" align="right">
        <button id="loadAll" class="btn btn-primary" style="position:relative;font-size: 90% !important;width:100%;">
          <!-- <span class="spinner spinner-border spinner-border-sm" role="status" style="width: 1rem;height: 1rem;color: white;margin-right:5px;" aria-hidden="true"></span> -->
          <i class="bi bi-file-earmark-arrow-up"></i><span>&nbsp;Load RFQ</span>
        </button>
      </div>
    </div>

    {{FOOTER}}

    <!-- Warning Alert Popup -->
    <div class="modal fade" id="warningAlert" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="warningAlertLabel" aria-hidden="true">
      <div class="modal-dialog" style="max-width:450px;">
        <div class="modal-content shadow-lg" style="border-radius:10px;">
          <div class="modal-header" style="padding: 1rem 1rem 0.1rem 1rem;border-bottom: none;">
            <h5 class="modal-title" id="warningAlertLabel" style="font-size:18px;">Please check</h5>
          </div>
          <div class="modal-body" style="padding: 0.5rem 1rem 0.5rem 1rem;">
            <div id="alertMessage" style="font-size:14px;"></div>
          </div>
          <div class="modal-footer" style="padding: 1rem;border-top: none;">
            <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal" style="margin:0;padding-left:0.8rem;padding-right:0.8rem;">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirm Alert Popup -->
    <div class="modal fade" id="confirmAlert" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="confirmAlertLabel" aria-hidden="true">
      <div class="modal-dialog" style="max-width:450px;">
        <div class="modal-content shadow-lg" style="border-radius:10px;">
          <div class="modal-header" style="padding: 1rem 1rem 0.1rem 1rem;border-bottom: none;">
            <h5 class="modal-title" id="confirmAlertLabel" style="font-size:18px;">Please confirm</h5>
          </div>
          <div class="modal-body" style="padding: 0.5rem 1rem 0.5rem 1rem;">
            <div id="confirmMessage" style="font-size:14px;"></div>
          </div>
          <div class="modal-footer" style="padding: 1rem;border-top: none;">
            <button type="button" class="btn btn-sm modal-alert-btn-cancel" data-bs-dismiss="modal" style="margin:0;padding-left:0.8rem;padding-right:0.8rem;">Cancel</button>
            <button type="button" class="btn btn-primary btn-sm modal-alert-btn-confrim" data-bs-dismiss="modal" style="margin:0;padding-left:0.8rem;padding-right:0.8rem;">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Backdrop -->
    <div id="toastBackdrop" class="toast-backdrop d-none"></div>
    <!-- Success/Fail message popup -->
    <div class="toast-container position-fixed p-3" style="z-index: 9999; left: 50%; top: 5px;width:350px;margin-left:-175px;">
      <div id="successToast" class="toast fade shadow" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false" tabindex="-1"><!--data-bs-delay="3000"-->
        <div class="toast-header">
          <!-- <img src="..." class="rounded mr-2" alt="..."> -->
          <strong class="mr-auto" style="color:#00b5cb;font-size:115%;"><i class="bi bi-check2-circle"></i> Updated!</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" style="color:gray;font-size:90%;">
          <span id="successAlertType"></span> for <span style="font-weight:500">RFQ #<span id="successAlertId"></span></span> was updated successfully.
        </div>
      </div>
      <div id="failToast" class="toast fade shadow" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false" tabindex="-1">
        <div class="toast-header">
          <strong class="mr-auto" style="color:#cc2b4f;font-size:115%;"><i class="bi bi-exclamation-octagon"></i> Failed..</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" style="color:gray;font-size:90%;">
          <span class="fail-error-message"></span>
        </div>
      </div>
    </div>

    <!-- <center><iframe width="1210px" height="900px" src="https://lookerstudio.google.com/embed/reporting/db6b02e5-268a-4390-9e3b-3b92c908fab4/page/h7NID" frameborder="0" style="border:0" allowfullscreen sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe></center>

    <center><iframe width="1210px" height="900px" src="https://docs.google.com/spreadsheets/d/1ao6DE6aQ4Iy8hgaFs5iyYxY2ZurYRjTtvmKHuUefsnY/edit?usp=sharing?widget=true&amp;headers=true" frameborder="0" style="border:0" allowfullscreen sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe></center> -->
    
    
    <!--jQuery & jQueryUI cdn -->
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js" integrity="sha256-J8ay84czFazJ9wcTuSDLpPmwpMXOm573OUtZHPQqpEU=" crossorigin="anonymous"></script>

    <!--bootstrap and popper cdn -->
    
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script> -->

    <!-- bootstrap select -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/js/bootstrap-select.min.js"></script> -->
    <!-- Latest compiled and minified JavaScript -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/i18n/defaults-*.min.js"></script> -->
    <?!= include('[JS]Bootstrap-Select.js'); ?>

    <!-- Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/v/bs5/dt-2.1.3/sl-2.0.4/datatables.min.js"></script>
    <!-- <script src="https://cdn.datatables.net/v/dt/dt-2.1.3/sl-2.0.4/datatables.min.js"></script> -->
    <script src="https://cdn.datatables.net/plug-ins/2.1.6/features/scrollResize/dataTables.scrollResize.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/5.0.1/js/dataTables.fixedColumns.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/5.0.1/js/fixedColumns.bootstrap5.js"></script>


    <!-- moment -->
    <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>

    <!-- Date Range Picker -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <?!= include('[JS]Navbar'); ?> <!--INCLUDE [JS]Navbar.html FILE-->

    <script>
      var mergedInfo;
      //var tableData;
      var rfq_id_val;
      var list_header;
      var table;
      var dataArray;
      
      google.script.run.withSuccessHandler(showRFQOS).withFailureHandler(function (error) {
        console.error("Error in fetching RFQ data: ", error);
      }).getRFQOS();

      function showRFQOS(response) {
        //console.log(response);
        $(document).ready(function() {

          dataArray = response.dataArray;
          var tableColumns = dataArray[0].map((str, index) => ({ title : str }));
          var tableData = dataArray.slice(1);

          mergedInfo = response.mergedInfo;
          list_header = dataArray[0];
          //tableData = response.dataArray;

          // Populate Status, Owner, Client checkboxes dynamically
          var statusIdx = list_header.indexOf('Status'),
              ownerIdx = list_header.indexOf('Owner'),
              clientIdx = list_header.indexOf('Client'),
              dateIdx = list_header.indexOf('RFQ Date');

          // Initialize the daterangepicker
          var dateRange = { start: startDate, end: endDate }; // Object to store the selected date range


          var mergedCellsTracker = {}; // Track merged cells

          // Initialize DataTable
          table = $('#rfqListTable').DataTable({
            deferRender: true,
            data:tableData,
            columns:tableColumns,
            columnDefs: [	
              { 
                targets: list_header.indexOf('RFQ ID'),
                render : function ( data, type, row, meta ) {                  
                  return `<a class="rfq-id-link" data-bs-toggle="offcanvas" href="#offcanvasRight" role="button" aria-controls="offcanvasRight">${data}</a>`;
                }
              },
              { 
                targets: list_header.indexOf('Status'),
                render : function ( data, type, row, meta ) {   
                  var $select = $(`
                    <select class="rfq-data-status form-select form-select-sm" data-status="${data}" value="${data}">
                      <option value="">Choose</option>
                      <option value="Ordered">Ordered</option>
                      <option value="Failed">Failed</option>
                      <option value="Pending">Pending</option>
                      <option value="Pass">Pass</option>
                      <option value="Bidding">Bidding</option>
                      <option value="Delete">Delete</option>
                      <option value="Terminate">Terminate</option>
                    </select>`);
                  $select.find('option[value="'+data+'"]').attr('selected', 'selected');
                  return $select[0].outerHTML + '<span class="spinner spinner-border spinner-border-sm" role="status" style="width: 1rem;height: 1rem;color: #475562;" aria-hidden="true"></span>';
                },
                className : 'dt-center'
              },
              { 
                targets: list_header.indexOf('Output URL'),
                render : function ( data, type, row, meta ) {   
                  return data !== '' ? `<a href="${data}" target="_blank">Link</a>` : '';
                },
                className : 'dt-center'
              }
            ],
            //dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
            fixedColumns: { start: 3 },
            language: { search: '', searchPlaceholder: "Search all" },
            search: { return: true },
            order: [],
            //order: [[0, 'desc']],
            scrollX: true,
            scrollResize: true,
            scrollCollapse: true,
            scrollY: 100,
            autoWidth: false,   // Disable auto width calculation to avoid issues with merged cells
            paging: true,
            pageLength: 25,
            ordering: false,      // Disable ordering because of merged cells
            info: true,          // Disable table info to reduce DOM manipulation
            autoWidth: false,     // Disable automatic width adjustments
            destroy: true,        // Allow reinitialization without issues
            createdRow: function (row, data, dataIndex) {

              var i = dataIndex + 1;

              //console.log(i);

              for(let j = 0; j < data.length; j++) {
                let mergedCell = mergedInfo.find(merge => merge.row === i && merge.col === j); // Check if this is a merged cell
              
                // Skip cells that are part of a merged region
                if (mergedCellsTracker[i + '-' + j]) {
                  $(row).find('td').eq(j).addClass('d-none');
                  continue; // Skip to the next iteration
                }

                if (mergedCell) {
                  // Handle merged cells
                  $(row).find('td').eq(j).attr('rowspan', mergedCell.rowspan);

                  // Mark the merged cells to skip in the subsequent iterations
                  for (let rowOffset = 0; rowOffset < mergedCell.rowspan; rowOffset++) {
                    mergedCellsTracker[(i + rowOffset) + '-' + j] = true;
                  }
                }
              }

            },
            initComplete: function(settings, json) {
              $('.dt-search').prepend($('.filter-dropdown'));
              $('.dt-search').prepend($('#selectDateRange'));
              $('.dt-search').prepend($('.go-to-btn-container'));
              $('.filter-dropdown,#selectDateRange,.go-to-btn-container').toggleClass('d-none');
              //$('#rfqListTable_wrapper > div.row > div:nth-child(1)').hide();
              $('#rfqListTable_wrapper > div.row > div:nth-child(2)').removeClass('col-sm-12 col-md-6');
              
              $('.table-loading-spinner-container').toggleClass('d-none');
              $('.table-loading-spinner').toggleClass('spinner-busy');

              var this_table = this.api();

              this_table.on('draw', function () {
                var pageInfo = this_table.page.info();
                var previousPageIndex = pageInfo.page - 1; // Calculate previous page index
                //var startIndex = pageInfo.start; // Index of the first visible row on the current page
                var rows = this_table.rows({ page: 'current' }).nodes(); // Get the visible rows
                var lastRowIndex;
                //var firstRowIndex;
                var previous_last_row;

                  
                var row = rows[0];
                //var rowIndex = startIndex + 0 + 1; // Adjust to match 1-based index
                var $firstCell = $(row).find('td').eq(0); // Get the first column of the row
                var first_val = $firstCell.text();
                var merge_len = Object.entries(rows).filter(cell => $(cell).find('td').eq(0).text() === first_val).length;

                console.log($firstCell);
                console.log("First val : " + first_val);

                console.log("Merge length : " + merge_len);

                var rowIndex = dataArray.findIndex(arr => arr[0] === first_val);
                var mergedCell = mergedInfo.filter(merge => merge.row === rowIndex);

                console.log("Row index : " + rowIndex);

                console.log("Previous page index : " + previousPageIndex);

                console.log(mergedCell);

                // Previous page information
                if (previousPageIndex >= 0) {
                  // Calculate the last row index of the previous page
                  lastRowIndex = (previousPageIndex + 1) * pageInfo.length - 1;
                  var lastRow = this_table.row(lastRowIndex).node();
                  var $lastCell = $(lastRow).find('td').eq(0);


                  //var mergedCellInfo = mergedInfo.find(merge => merge.row === last_val);

                  if (dataArray.filter(arr => arr[0] === first_val).length !== merge_len) { //$lastCell.hasClass('d-none') || 
                    //let last_val = $lastCell.text();
                    // If the last row is part of a merged group, find the first row of the group
                    lastRowIndex = dataArray.findIndex(arr => arr[0] === first_val) - 1;
                    console.log("Last val : " + first_val);

                    // Get the DOM element of the first row of the merged group
                    previous_last_row = this_table.row(lastRowIndex).node(); // Adjust for 0-based indexing

                  } else {
                    // If the last row is not part of a merged group, get the last row itself
                    previous_last_row = this_table.row(lastRowIndex).node();

                  }

                  //console.log(previous_last_row);
                  console.log("Last row index : " + lastRowIndex);
                }

                if (dataArray.filter(arr => arr[0] === first_val).length !== merge_len) { //$firstCell.hasClass('d-none')
                  console.log(mergedCell)
                  // Loop through all columns to handle merged cells
                  mergedCell.forEach((obj,idx) => {

                    let $cell = $(row).find('td').eq(obj.col);


                    if ($(previous_last_row).find) {
                      // Use rendered row data
                      var status_val = $(previous_last_row).find('td').eq(list_header.indexOf('Status')).find('select.rfq-data-status').val();
                      var url_val = $(previous_last_row).find('td').eq(list_header.indexOf('Output URL')).html();
                      var comments_val = $(previous_last_row).find('td').eq(list_header.indexOf('Notes')).text();
                    } else {
                      // Use dataArray
                      var status_val = dataArray[lastRowIndex][list_header.indexOf('Status')];
                      var url_val = dataArray[lastRowIndex][list_header.indexOf('Output URL')];
                      var comments_val = dataArray[lastRowIndex][list_header.indexOf('Notes')];
                    }

                    console.log(status_val);

                    if(obj.col !== list_header.indexOf('RFQ ID') && obj.col !== list_header.indexOf('Status') && obj.col !== list_header.indexOf('Notes') && obj.col !== list_header.indexOf('Output URL')) {
                      $cell.text(obj.mergedValue);
                    } else {
                      if( obj.col === list_header.indexOf('Status') ) {
                        //console.log($(previous_last_row).find('td').eq(list_header.indexOf('RFQ ID')));
                        $cell.find('select.rfq-data-status').val(status_val);
                        $cell.find('select.rfq-data-status').attr("data-status",status_val);
                      }
                      if( obj.col === list_header.indexOf('Notes') ) $cell.text(comments_val);
                      //if( obj.col === list_header.indexOf('Output URL') ) $cell.html(url_val.toString());
                    }

                    $cell.removeClass('d-none');
                    $cell.attr('rowspan', merge_len);
                    
                    // addclass d-none for merging cells below first row...
                    
                  });
                }
              //}
                this_table.columns.adjust();
              });

              function processColumnData(columnIdx, filterId, checkboxClass) {
                const uniqueArray = [];
                this_table.column(columnIdx).data().unique().each(function (value) {
                  // if (filterId == 'statusFilters') { 
                  //   let elements = $(value);
                  //   value = $(elements[0]).attr('data-status'); 
                  // }
                  if (value !== undefined) uniqueArray.push(value);
                });
                uniqueArray.sort().forEach(function (val) {
                  $(`#${filterId}`).append(`
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input ${checkboxClass}" id="${checkboxClass}-${val}" value="${val}">
                      <label class="form-check-label" for="${checkboxClass}-${val}">${val}</label>
                    </div>
                  `);
                });
              }
        
              // Process each column
              processColumnData(statusIdx, 'statusFilters', 'status-checkbox');
              processColumnData(ownerIdx, 'ownerFilters', 'owner-checkbox');
              processColumnData(clientIdx, 'clientFilters', 'client-checkbox');

              // 날짜 선택 범위 변경 이벤트 핸들러 함수 | Date range selection change event handler function
              function cb(startDate, endDate) {
                  $('#selectDateRange span').html(startDate.format('MMMM D, YYYY') + ' - ' + endDate.format('MMMM D, YYYY'));
              }

              // 날짜 범위 선택기 초기화 | Initialize date range picker
              $('#selectDateRange').daterangepicker({
                  startDate: startDate,
                  endDate: endDate,
                  "opens": "center",
                  ranges: {
                      'Today': [moment(), moment()],
                      'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                      'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                      'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                      'This Month': [moment().startOf('month'), moment().endOf('month')],
                      'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
                      'This Year' : [moment().startOf('year'), moment().endOf('year')]
                  }
              }, cb);

              // 초기 콜백 호출 | Initial callback invocation
              cb(startDate, endDate);

              this_table.columns.adjust();
              
              // if(managerName !== undefined) {
              //   //this.api().column(list_header.indexOf('Owner')).search(managerName).draw().columns.adjust();
              //   $(`#owner-checkbox-${ managerName }`).prop('checked', true).change();
              // }
            }
          });

          // Define groups and their corresponding column indexes
          var groups = {
            status: { selector: '.status-checkbox', column: statusIdx },
            owner: { selector: '.owner-checkbox', column: ownerIdx },
            client: { selector: '.client-checkbox', column: clientIdx }
          };

          // Combined custom search logic for checkboxes and merged group search
          $.fn.dataTable.ext.search.push(function (settings, rowData, rowIndex) {
            var searchTerm = $('input#dt-search-0').val();

            //console.log(rowData);

            // Step 1: Handle checkbox filters
            var selectedFilters = {};
            Object.keys(groups).forEach(function (key) {
              var group = groups[key];
              selectedFilters[key] = $(group.selector + ':checked').map(function () {
                return this.value;
              }).get();
            });

            var isFilterApplied = Object.values(selectedFilters).some(function (values) {
              return values.length > 0;
            });

            var matchesFilters = Object.keys(selectedFilters).every(function (key) {
              var group = groups[key];
              var selectedValues = selectedFilters[key];

              // Skip this filter if no values are selected for this group
              if (selectedValues.length === 0) return true;

              // Check if the cell value matches any of the selected values
              //var regex = new RegExp(selectedValues.join('|'));
              var regex = new RegExp(`^(${selectedValues.join('|')})$`);
              return tableData
                .filter(arr => arr[0] === rowData[0]) // Find the merged group for this row
                .some(arr => regex.test(arr[group.column])); // Check if any part of the merge matches
            });

            // Step 2: Handle search functionality
            var matchesSearch = !searchTerm || tableData
              .filter(arr => arr[0] === rowData[0]) // Find the merged group for this row
              .some(arr => new RegExp(searchTerm, 'i').test(arr));

            // Step 3: Handle date range filtering
            var matchesDateRange = true;
            if (dateRange.start && dateRange.end) {
              matchesDateRange = tableData
                .filter(arr => arr[0] === rowData[0]) // Find the merged group for this row
                .some(arr => moment(arr[dateIdx], 'M/D/YYYY').isBetween(dateRange.start, dateRange.end, 'day', '[]')); // Check if any part of the merge matches
            }

            // Row is shown if it matches all criteria: filters, search term, and date range
            return (!isFilterApplied || matchesFilters) && matchesSearch && matchesDateRange;
          });

          $('#selectDateRange').on('show.daterangepicker', function(ev, picker) {
            $(this).addClass('show-date-picker');
          });

          $('#selectDateRange').on('hide.daterangepicker', function(ev, picker) {
            $(this).removeClass('show-date-picker');
          });

          let searchDebounceTimeout, filterDebounceTimeout;

          // Event listener for checkboxes
          $(document).on('change', '.status-checkbox, .owner-checkbox, .client-checkbox', function () {
            const totalCnt = $('.filter-dropdown-menu .form-check-input:checked').length;
            const statusSubCnt = $('.filter-dropdown-menu .form-check-input.status-checkbox:checked').length;
            const ownerSubCnt = $('.filter-dropdown-menu .form-check-input.owner-checkbox:checked').length;
            const clientSubCnt = $('.filter-dropdown-menu .form-check-input.client-checkbox:checked').length;
            
            //console.log(totalCnt);
            $('.filter-dropdown .filter-cnt-status').text(statusSubCnt);
            $('.filter-dropdown .filter-cnt-owner').text(ownerSubCnt);
            $('.filter-dropdown .filter-cnt-client').text(clientSubCnt);
            $('.filter-cnt-total').text(totalCnt);

            //table.draw(); // Trigger the custom filter

            clearTimeout(filterDebounceTimeout); // Clear any pending redraw

            // Set a timeout to redraw the table after 300ms
            filterDebounceTimeout = setTimeout(function () {
              table.draw(); // Perform search within the already filtered data
            }, 300); // Adjust delay time as needed (e.g., 200-500ms)
          });


          //let debounceTimeout;
          
          // Search event listener for DataTables' dt-search
          $('input#dt-search-0').on('input', function (e) {
            clearTimeout(searchDebounceTimeout); // Clear any pending redraw

            // Set a timeout to redraw the table after 300ms
            searchDebounceTimeout = setTimeout(function () {
              table.draw(); // Perform search within the already filtered data
            }, 300); // Adjust delay time as needed (e.g., 200-500ms)

            if ($(this).val().length === 0){
              table.search('').draw();
            }
          });

          document.getElementById("dt-search-0").addEventListener("search", function(event) {
             table.search('').draw();
          });

          // Reset filters button
          $('#clearFilter').click(function () {
            $('.filter-dropdown-menu .form-check-input:checked').prop('checked', false).trigger('change'); // Uncheck all checkboxes
            table.draw(); // Reset table filter
          });

          // Search inside the accordion
          $('#statusSearch,#ownerSearch,#clientSearch').on('keyup', function () {
            var searchValue = $(this).val().toLowerCase();
            $(this).closest('.accordion-body').find('.form-check').each(function () {
              var label = $(this).find('label').text().toLowerCase();
              $(this).toggle(label.indexOf(searchValue) > -1); // Show/hide based on search
            });
          });

          //$('#selectDateRange').trigger('apply.daterangepicker');

          // Update dateRange object when a range is selected
          $('#selectDateRange').on('apply.daterangepicker', function (ev, picker) {
            dateRange.start = picker.startDate;
            dateRange.end = picker.endDate;
            //$(this).val(picker.startDate.format('M/D/YYYY') + ' - ' + picker.endDate.format('M/D/YYYY'));
            table.draw(); // Redraw the table when the date range changes
          });

          
        });

        
      }

      function handleFormSubmit(formObject) {    
        // Google 스크립트 실행 | Execute Google script
        google.script.run
            .withFailureHandler(e => {
              // 실패 시 오류 메시지 표시 | Display error message on failure
              $('.fail-error-message').text(e.message);

              // 버튼 활성화 및 로딩 스피너 숨김 | Enable button and hide loading spinner
              $('select.rfq-data-status.d-none+.spinner-busy').toggleClass('spinner-busy');
              $('select.rfq-data-status.d-none').toggleClass('d-none');

              // 실패 메세지 표시 | Display failure message
              $('#failToast').toast('show');
            })
            .withSuccessHandler(e => {

              // 버튼 활성화 및 로딩 스피너 숨김 | Enable button and hide loading spinner
              $('select.rfq-data-status.d-none+.spinner-busy').toggleClass('spinner-busy');
              $('select.rfq-data-status.d-none').toggleClass('d-none');
              
              // 성공 메세지 표시 | Display success message
              $('#successToast').toast('show');

              setTimeout(function() {
                  $('#successToast').toast('hide');
              }, 3000);
              //console.log(e);
              
            })
            .doPost(formObject);
      }

      $(function(){
        $(document).on('mousedown','select.rfq-data-status', function(e){
          //e.preventDefault();
          if($('#offcanvasRight').hasClass('show')) {
            $('#offcanvasRight .btn-close').trigger('click');
          }

          $(this).one('change', function(){
            var selected_val = $(this).val();
            var rfq_id = $(this).closest('tr').find('td').eq(0).text().replace(/\s+/g, '');

            //console.log(selected_val);
            //console.log(rfq_id);

            $('#rfqId').val(rfq_id);
            $('#successAlertId').text(rfq_id);
            $('#successAlertType').text('Status');
            $('#rfqStatus').val(selected_val);
            $('#rfqStatusForm').submit();
            
            $(this).toggleClass('d-none');
            $(this).next().toggleClass('spinner-busy');
            $(this).attr('data-status', selected_val);

          });
          
        });

        $(document).on('click', '.rfq-id-link', function(e){
          //e.preventDefault();
          if($('#offcanvasRight').hasClass('show')) {
            $('#offcanvasRight').children().css('opacity','0');
            $('#offcanvasRight').one('hidden.bs.offcanvas', function(){
              //console.log(e.target);
              var offcanvas = new bootstrap.Offcanvas($('#offcanvasRight')[0]);
              // Show the offcanvas
              $('#offcanvasRight').children().css('opacity','1');
              offcanvas.show();
            });
          }
          
          $(this).closest('tbody').find('tr.active-row').removeClass('active-row');
          $(this).closest('tr').addClass('active-row');

          rfq_id_val = $(this).text().replace(/\s+/g, '');
          var $activeRow = $('#rfqListTable tbody').find('.active-row td');
          var $offcanvasTableTd = $('#offcanvasRight').find('.offcanvas-details-table tbody td');
          $offcanvasTableTd.html('');
          var row_span = Number($activeRow.eq(0).attr('rowspan') || 1);

          var status_val = $activeRow.eq(list_header.indexOf('Status')).find('select.rfq-data-status').val();
          var date_val = $activeRow.eq(list_header.indexOf('RFQ Date')).text();
          var owner_val = $activeRow.eq(list_header.indexOf('Owner')).text();
          var countries_val = [];
          var client_val = $activeRow.eq(list_header.indexOf('Client')).text();
          var client_name_val = $activeRow.eq(list_header.indexOf('Client name')).text();
          var project_name_val = $activeRow.eq(list_header.indexOf('Project name (Mail title)')).text();
          var targeting_val = $activeRow.eq(list_header.indexOf('Targeting condition')).text();
          var project_type_val = $activeRow.eq(list_header.indexOf('Project type')).text();
          var sales_val = $activeRow.eq(list_header.indexOf('Total sales')).text();
          var gm_val = $activeRow.eq(list_header.indexOf('Total GM')).text();
          var gm_per_val = $activeRow.eq(list_header.indexOf('Total GM (%)')).text();
          //var url_val = $activeRow.eq(list_header.indexOf('Output URL')).find('a').attr('href');
          var url_val = $activeRow.eq(list_header.indexOf('Output URL')).html();
          var comments_val = $activeRow.eq(list_header.indexOf('Notes')).text();

          //console.log(dataArray);

          // var date_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('RFQ Date')];
          // var owner_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('Owner')];
          // var client_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('Client')];
          // var client_name_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('Client name')];
          // var project_name_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('Project name (Mail title)')];
          // var targeting_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('Targeting condition')];
          // var project_type_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('Project type')];
          // var sales_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('Total sales')];
          // var gm_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('Total GM')];
          // var gm_per_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('Total GM (%)')];
          // var url_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('Output URL')];
          // var comments_val = dataArray.find(arr => arr[0] === rfq_id_val)[list_header.indexOf('Notes')];

          // for(var i=0; i < row_span; i++){
          //   var index = $activeRow.closest('tr').index() + i;
          //   var country_val = $('#rfqListTable tbody tr').eq(index).find('td').eq(list_header.indexOf('Country')).text();

          //   countries_val.push(country_val);
          // }

          dataArray.filter(arr => arr[0] === rfq_id_val).forEach(arr => countries_val.push(arr[list_header.indexOf('Country')]));

          $('#offCanvasInsertRFQId').text(rfq_id_val);
          $offcanvasTableTd.eq(0).append(`<div class="rfq-data-status" data-status="${status_val}">${status_val}</div>`);
          //$offcanvasTableTd.eq(0).find('div.rfq-data-status').text(status_val);
          //$offcanvasTableTd.eq(0).find('div.rfq-data-status').attr('data-status',status_val);
          $offcanvasTableTd.eq(1).text(date_val);
          $offcanvasTableTd.eq(2).text(owner_val);
          $offcanvasTableTd.eq(3).text([ ...new Set(countries_val) ].join(', '));
          $offcanvasTableTd.eq(4).text(client_val);
          $offcanvasTableTd.eq(5).text(client_name_val);
          $offcanvasTableTd.eq(6).text(project_name_val);
          $offcanvasTableTd.eq(7).text(targeting_val);
          $offcanvasTableTd.eq(8).text(project_type_val);
          $offcanvasTableTd.eq(9).text('₩ ' + sales_val);
          $offcanvasTableTd.eq(10).text('₩ ' + gm_val);
          $offcanvasTableTd.eq(11).text(gm_per_val + '%');
          // $offcanvasTableTd.eq(12).append(url_val === undefined ? '' : `
          //                         <a href="${url_val}" target="_blank">Link</a>`);
          $offcanvasTableTd.eq(12).append(`
          <span id="outputURLSpan">${url_val}</span>
          <input type="url" pattern="https://.*" class="input-number form-control form-control-sm d-none" id="outputURLInput" value="${ url_val === '' ? '' : $(url_val).attr('href') }" style="font-size:13px !important;width:83%;">
          <button class="btn btn-sm position-absolute edit-input-offcanvas" type="button"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm position-absolute d-none cancel-edit-offcanvas" type="button"><i class="bi bi-x-circle"></i></button>
          <button class="btn btn-sm position-absolute d-none save-edit-offcanvas" type="button"><i class="bi bi-check-circle"></i></button>`);
          $offcanvasTableTd.eq(13).append(`
          <textarea class="form-control form-control-sm textarea-readonly" id="rfqCommentsInput" rows="3" style="font-size:13px !important;width:83%;" placeholder="Notes" readonly>${comments_val}</textarea>
          <button class="btn btn-sm position-absolute edit-input-offcanvas" type="button"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm position-absolute d-none cancel-edit-offcanvas" type="button"><i class="bi bi-x-circle"></i></button>
          <button class="btn btn-sm position-absolute d-none save-edit-offcanvas" type="button"><i class="bi bi-check-circle"></i></button>`);
          
        });

        $(document).on('click', 'button.edit-input-offcanvas', function(e) {
            e.preventDefault();

            var $parent = $(this).closest('td');
            var $input = $parent.find('input,textarea');
            //var $input = $parent.find('textarea');
            var prevName = $input.val().trim();

            // Generic toggle function for enabling/disabling edit mode
            function toggleEditing(isEditing) {

                if($input.attr('id') === 'outputURLInput') {
                  $parent.find('#outputURLSpan').toggleClass('d-none', isEditing);
                  $input.toggleClass('d-none', !isEditing);
                } else {
                  $input.toggleClass('textarea-readonly', !isEditing);
                  $input.prop('readonly', !isEditing);
                }
              
                
                $parent.find('button.save-edit-offcanvas, button.cancel-edit-offcanvas').toggleClass('d-none', !isEditing);
                $parent.find('button.edit-input-offcanvas').toggleClass('d-none', isEditing);
                
                if (isEditing) {
                    $input.focus();
                    var tmpStr = $input.val();
                    $input.val('');
                    $input.val(tmpStr);
                }
            }

            toggleEditing(true);

            // Event handler for cancel action
            $parent.find('button.cancel-edit-offcanvas').off('click').on('click', function() {
                  $input.val(prevName);
                  toggleEditing(false);
            });

            $input.on('keyup', function(e) {
              if(e.key === 'Enter') {
                $parent.find('button.save-edit-offcanvas').trigger('click');
              }
            });
            
            var move_on = true;

            // Event handler for save action
            $parent.find('button.save-edit-offcanvas').off('click').on('click', function() {
                var curName = $input.val().trim();
                var $activeRow = $('#rfqListTable tbody').find('.active-row td');
                var rfq_id = $activeRow.eq(0).text().replace(/\s+/g, '');
                const isValidUrl = (urlString) => {
                    var urlPattern = new RegExp('^(https?:\\/\\/)?' + // validate protocol
                        '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' + // validate domain name
                        '((\\d{1,3}\\.){3}\\d{1,3}))' + // validate OR ip (v4) address
                        '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' + // validate port and path
                        '(\\?[;&a-z\\d%_.~+=-]*)?' + // validate query string
                        '(\\#[-a-z\\d_]*)?$', 'i'); // validate fragment locator
                    return !!urlPattern.test(urlString);
                }

                if($input.attr('id') === 'outputURLInput') {
                  if (!isValidUrl(curName)) {
                      if (lang == "ko" || lang == "") {
                          $('#alertMessage').text('URL을 정확히 입력해주세요.');
                      }
                      if (lang == "en") {
                          $('#alertMessage').text('Enter a valid URL.');
                      }
                      $('#warningAlert').modal('show');
                      //$input.focus();
                      move_on = false;
                  } else {
                      $('#rfqOutputURL').val(curName);
                      $('#formType').val('update-outputurl');
                      $('#successAlertType').text('Output URL');
                      $('#outputURLSpan').html('<a href="' + curName + '" target="_blank">Link</a>');
                      $activeRow.eq(list_header.indexOf('Output URL')).html('<a href="' + curName + '" target="_blank">Link</a>');
                  }
                  
                } else {
                  $('#rfqComments').val(curName);
                  $('#formType').val('update-comments');
                  $('#successAlertType').text('Notes');
                  //$('#rfqCommentsSpan').text(curName);
                  $activeRow.eq(list_header.indexOf('Notes')).text(curName);
                }

                if(move_on) {
                  $input.val(curName);
                  toggleEditing(false);

                  $('#rfqId').val(rfq_id);
                  $('#successAlertId').text(rfq_id);

                  table.columns.adjust();
                  $('#rfqStatusForm').submit();
                } else {
                  $input.val(prevName);
                  //$input.focus();
                  //move_on = true;
                  //toggleEditing(true);
                }
                
            });


            $input.off('blur').on('blur', function(e) {
              if(!move_on) {
                $input.focus();
                move_on = true;
              }

              //console.log(e.relatedTarget);
              if ($input.prop('readonly') == false && move_on) {
                if(!$(e.relatedTarget).hasClass('cancel-edit-offcanvas') && !$(e.relatedTarget).hasClass('save-edit-offcanvas')) {
                  $input.val(prevName);
                  toggleEditing(false);
                }
              }

              
            });


        });

        $(document).on('click', '#copyCRMProject', function(e){
          e.preventDefault();

          var changeToCRMOwner = {
            "SH":"Saehee",
            "YG":"Younggyo",
            "Y":"Yunyi",
            "AY":"Ahyoung",
            "Hoi":"Hoi Jin",
            "SY":"Suyeon",
            "Hiedi":"Hiedi",
            "Tricia":"Tricia Mae",
            "Rizza":"Rizza Michaela",
            "Chantal":"Chantal Angeli",
            "test":"Seunghyun"
          };

          var changeToCRMProduct = {
            "Adhoc":"1",
            "Topup":"16",
            "Tracking":"2",
            "FS":"3",
            "LSI":"14",
            "Others":"18"
          };

          var $activeRow = $('#rfqListTable tbody').find('.active-row td');
          var row_span = Number($activeRow.eq(0).attr('rowspan') || 1);
          var countries_arr = [];
          var countries_full_arr = [];
          var proposal_cpi_arr = [];
          var requested_n_arr = [];

          for(var i=0; i < row_span; i++){
            var index = $activeRow.closest('tr').index() + i;
            var country_val = $('#rfqListTable tbody tr').eq(index).find('td').eq(list_header.indexOf('GID')).text().toUpperCase();
            var country_full_val = $('#rfqListTable tbody tr').eq(index).find('td').eq(list_header.indexOf('Country')).text();
            var cpi_val = $('#rfqListTable tbody tr').eq(index).find('td').eq(list_header.indexOf('Proposal CPI')).text().replace(/,/g , '');
            var requested_n_val = $('#rfqListTable tbody tr').eq(index).find('td').eq(list_header.indexOf('Requested N')).text().replace(/,/g , '');

            countries_arr.push(country_val);
            countries_full_arr.push(country_full_val);
            proposal_cpi_arr.push(cpi_val);
            requested_n_arr.push(requested_n_val);
          }

          // var $offcanvas = $(this).closest('.offcanvas');
          // var $offcanvasTable = $offcanvas.find('table.offcanvas-details-table');
          var $activeRow = $('#rfqListTable tbody').find('.active-row td');
          var input_project_name = $activeRow.eq(list_header.indexOf('Project name (Mail title)')).text();
          var input_targeting_condition = $activeRow.eq(list_header.indexOf('Targeting condition')).text();
          var input_sales_region = '4';
          var input_account_name = $activeRow.eq(list_header.indexOf('Client')).text();
          var input_owner_name = changeToCRMOwner[$activeRow.eq(list_header.indexOf('Owner')).text()];
          var input_currency = 'KRW';
          var input_close_date = moment().endOf('month').format('YYYY-MM-DD');
          var input_product_type = changeToCRMProduct[$activeRow.eq(list_header.indexOf('Project type')).text()];
          //var input_country = $activeRow.eq(list_header.indexOf('Country')).text();
          var input_country = countries_arr.join(",");
          var input_country_full = countries_full_arr.join(",");
          //var input_requested_n = $activeRow.eq(list_header.indexOf('Requested N')).text();
          var input_requested_n = requested_n_arr.join(",");
          //var input_cpi = $activeRow.eq(list_header.indexOf('CPI')).text().replace(/,/g , '');
          var input_cpi = proposal_cpi_arr.join(",");
          //var input_ir = $activeRow.eq(list_header.indexOf('Estimate IR')).text().replace(/,/g , '');
          var input_loi = $activeRow.eq(list_header.indexOf('LOI')).text().replace(/,/g , '');
          //console.log(countries_arr);
          var copyScript = `
const input_country = '${input_country}'.split(",");
const input_country_full = '${input_country_full}'.split(",");
const input_requested_n = '${input_requested_n}'.split(",");
const input_cpi = '${input_cpi}'.split(",");
let target_country = input_country[0];
let target_cpi = input_cpi[0];
let target_ss = input_requested_n[0];
const country_length = input_country.length;
const is_mcp = new Set(input_country_full).size > 1 ? true : false;
if(window.location.href.includes('opportunity') && country_length > 1) {
  target_country = prompt('Enter country code from : ' + input_country.join(" | "),'');
  const target_idx = input_country.findIndex(val => val === target_country.toUpperCase());
  target_cpi = input_cpi[target_idx];
  target_ss = input_requested_n[target_idx];
}
$('form[action$="project"] #input-name').val(is_mcp ? '[MCP] ' : '' + '${input_project_name}');
$('form[action$="project"] #input-sales_region_id').val('${input_sales_region}').change();
$('form[action$="project"] #input-account_name').val('${input_account_name}').trigger('input');
$('form[action$="project"] #input-currency_code').val('${input_currency}').change();
$('form[action$="opportunity"] #input-product_type').val('${input_product_type}').change();
$('form[action$="opportunity"] #input-country_code').val(target_country).change();
$('form[action$="opportunity"] #input-requested_n,form[action$="opportunity"] #input-estimated_n').val(target_ss);
$('form[action$="opportunity"] #input-project_name').val(is_mcp ? '[MCP] ' : '' + '${input_project_name}').trigger('input');
$('#input-owner_name').val('${input_owner_name}').trigger('input');
$('#input-closed_date').val('${input_close_date}');
$('form#quote-registration-form #input-cpi').val(target_cpi);
$('form#quote-registration-form #input-number_of_samples').val(target_ss);
$('form#quote-registration-form #input-loi').val('${input_loi}');
setTimeout(function() {
  $('form[action$="project"]').closest('body').find('#ui-id-1 li').each(function() { if($(this).text().toLowerCase() === '${input_account_name.toLowerCase()}') $(this).trigger('click'); });
  $('form[action$="project"]').closest('body').find('#ui-id-3 li:eq(0)').trigger('click');

  $('form[action$="opportunity"]').closest('body').find('#ui-id-1 li').each(function() { if($(this).text().toLowerCase() === '${input_project_name.toLowerCase()}') $(this).trigger('click'); });
  $('form[action$="opportunity"]').closest('body').find('#ui-id-2 li:eq(0)').trigger('click');
}, 1000);
if(window.location.href.includes('opportunity') && $('h6:contains("Opportunity Detail")').closest('div.card-body').find('span.text-body').eq(0) !== '' && ($('#openRMTemplate').length === 0 && $('#copyRMProject').length === 0)) {
  $('h6:contains("Opportunity Detail")').append('<a href="${"https://redmine.d8aspring.com/projects/shogo/issues/77547/copy"}" target="_blank" id="openRMTemplate" class="btn btn-sm" title="Open RM Template" type="button" style="margin-right:-.5rem;"><i class="fa fa-external-link-alt"></i></a><a href="#" id="copyRMProject" class="btn btn-sm" title="Copy RM Info" type="button"><i class="fa fa-copy"></i></a>');
}
$('#copyRMProject').on('click', function(e){
  e.preventDefault();

  const $parent = $(this).closest('div.card-body');
  let rmSubjectArr = $parent.find('span.text-body').eq(0).text().split('/');
  if(is_mcp) rmSubjectArr[0] = 'MCP';
  const rmSubject = rmSubjectArr.join('/');
  const rmCountry = is_mcp ? input_country_full : $parent.find('span.text-body').eq(6).text();
  const rmAccount = rmSubjectArr[1];

  const copyRM = \`
const rmSubject = '\${ rmSubject \}';
const rmAccount = '\${ rmAccount \}';
const rmOpportunity = '\${ $parent.find('span.text-body').eq(1).text() \}';
const rmDesc = \\\`
h1. [To. Ops team]

* Mail Title : ${input_project_name}
* Survey Title : 

* Compatibility : PC and Mobile
* Project type : \${ $parent.find('span.text-body').eq(2).text().trim() \}
* Country : \${ rmCountry \}

* Panel CPI : \${ is_mcp ? '' : $parent.find('span.text-body').eq(12).text() \}
* Setup/Programming/Other fee : \${ is_mcp ? '' : $('#quote-list tr:eq(0) td').eq(5).text() \}

* Estimated IR : \${ $('#quote-list tr:eq(0) td').eq(3).text() \}%
* Vendors 
- Mail Title : 
- Max Budget : 
- Note : 

* [Option] Excluding lists: None
* [Option] Incentive Type: ARS ON, Costs
* [Option] Footer/Introduction note(s): None

h1. [To. Ops & FS team]

* Target(대상자) : ${ input_targeting_condition }
* Quota(할당) : 
* Sample N(샘플수) : \${ $parent.find('span.text-body').eq(10).text() \} ss
* LOI(설문길이) : \${ $('#quote-list tr:eq(0) td').eq(2).text() \} mins
* Fieldwork Period(일정) : (급행건/갤럽/대학내일/이레귤러인 경우 필수)
* Note(참고사항) : (불량기준/검증문항 유무 및 조건/특이사항/Ops팀 디렉션)
\\\`;


 $('#issue_subject').val(rmSubject);
 $('#issue_description').val(rmDesc);
 $('#issue_custom_field_values_9').val(rmAccount);
 $('#issue_custom_field_values_15').val(rmOpportunity);
 $('#link_copy,#copy_subtasks').prop('checked',false);
\`;

  navigator.clipboard.writeText(copyRM);
  alert("Copied!");
});
`;

          navigator.clipboard.writeText(copyScript);

          $(this).attr('title', 'Copied!')
            // 툴팁 제목 수정 및 툴팁 표시 | Fix the tooltip title and show the tooltip
            .tooltip('_fixTitle')
            .tooltip('show')
            // 'copy-button'의 title 속성을 "Copy to Clipboard"으로 재설정 | Reset the 'title' attribute of 'copy-button' to "Copy to Clipboard"
            .attr('title', "Copy CRM Info")
            // 툴팁 제목 수정 | Fix the tooltip title
            .tooltip('_fixTitle');
        });

        $(document).on('click', '#loadAll', function(e){
            e.preventDefault();
            
            $('#loadAll .spinner').toggleClass('spinner-busy');
            google.script.run.withSuccessHandler(function(url){
                //console.log(url);
                // 현재 페이지 새로고침 | Refresh current page
                window.open(`${ url }?mode=Create-OS&rfqid=${ rfq_id_val }${ lang === 'en' ? '&lang=en' : '' }`,'_blank');
            }).getScriptURL();
        });

        

      });

      
    </script>
    
    <!--
    <?!= include('[JS]Functions(Common)'); ?> 
    <?!= include('[JS]Actions(Common)'); ?> 
    <?!= include('[JS]JavaScript(CreateOS)'); ?> 
    -->
  </body>
</html>