<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--INCLUDE REQUIRED EXTERNAL JAVASCRIPT AND CSS LIBRARIES-->
    
    <!-- jQuery UI -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">

    <!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script> -->
   

    <!-- Date Range Picker -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <!-- Bootstrap CSS -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous"> -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">

    <!-- fontawesome -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Bootstrap-select -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/css/bootstrap-select.min.css"> -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">

    <!-- Select2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <!-- Or for RTL support -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.rtl.min.css" />

    <!-- DataTables -->
    <link href="https://cdn.datatables.net/v/bs5/dt-2.1.3/sl-2.0.4/datatables.min.css" rel="stylesheet">
    <!-- <link href="https://cdn.datatables.net/v/dt/dt-2.1.3/sl-2.0.4/datatables.min.css" rel="stylesheet"> -->
    <link href="https://cdn.datatables.net/fixedcolumns/5.0.1/css/fixedColumns.bootstrap5.css" rel="stylesheet">

    <!-- bootstrap icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link href='https://fonts.googleapis.com/css?family=Quattrocento Sans' rel='stylesheet'>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
 
    <?!= include('[CSS]Style'); ?> <!--INCLUDE [CSS]Style.html FILE-->
    
  </head>
 
  <body>
    {{NAV_SIDEBAR}}

    <!-- Navigation bar -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
      <div class="nav-body">

        <!-- Page Title -->
        <div class="page-title"><span class="rfq-type-tag">KR</span> RFQ List</div>

      </div>
    </nav>

    <iframe name="hidden-iframe" style="position: absolute; visibility: hidden" sandbox="allow-top-navigation allow-scripts allow-forms allow-same-origin allow-popups"></iframe><!-- sandbox="allow-top-navigation allow-scripts allow-forms allow-same-origin" -->
    <!-- use for Live Link V2 -->
    <form id="rfqStatusForm" onsubmit="handleFormSubmit(this)" method="POST" action="https://script.google.com/macros/s/AKfycbzR4C6JvphST5AY-i8Gzpv1ECapoC0pwl4Xyv8qx4i2Mv8sIO8chVT4fKumq_VCIVr4/exec" target="hidden-iframe">
      <input type="hidden" name="RFQ ID" id="rfqId">
      <input type="hidden" name="RFQ Status" id="rfqStatus">
      <!-- <input type="hidden" name="CRM No." id="crmNumber"> -->
      <input type="hidden" name="Notes" id="rfqComments">
      <input type="hidden" name="Last submit type" id="formType" value="update-status">
      <input type="hidden" name="RFQ type" id="rfqType" value="KR">
    </form>

    <!-- Main body -->
    <div class="main-body">
      <div class="row">
        <div class="card shadow-sm" style="height: calc(100vh - 100px);max-height: calc(100vh - 100px);">
          <div class="card-body" style="height:100%;">
            <div class="go-to-btn-container d-none" style="display:inline-block;"><a class="btn btn-outline-secondary btn-sm go-to-btn"
                      href="https://docs.google.com/spreadsheets/d/1pWFTXnpKhO6VOzHT7KsjrUPxmKFwfQdlatTKmWvTjUk/edit?gid=0#gid=0"
                      target="_blank" data-bs-toggle="tooltip" data-bs-placement="top" title="Open KR RFQ List" role="button"><i
                        class="bi bi-box-arrow-up-right"></i></a>
            </div>
            <div id="selectDateRange" class="form-control form-control-sm d-none">
                <div style="display:flex;align-items:center;">
                  <i class="bi bi-calendar4" style="display:flex;align-items:center;"></i>&nbsp;&nbsp;
                  <span style="align-self:center;"></span>
                </div>
                <div style="display:flex;align-items:center;text-align:right;margin-left:auto;">
                  <i class="bi bi-chevron-down" style="display:flex;align-items:center;"></i>
                </div>
            </div>
            <div class="dropdown filter-dropdown d-none" style="display: inline-block;">
              <button type="button" id="showFilterDropdown" class="btn btn-outline-secondary btn-sm" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                <i class="bi bi-filter" style="display: flex;align-items: center;"></i> Filters 
                <span class="filter-cnt-total">0</span>
              </button>
              <div class="dropdown-menu p-2 filter-dropdown-menu">
                <div>
                  <div class="filter-header">
                    <label for="filterSelect">Filters</label>
                    <button id="clearFilter" class="btn btn-light btn-sm" style="background-color:white;position:relative;">
                      <i class="fa fa-refresh" style="font-size:11px;" aria-hidden="true"></i>
                    </button>
                  </div>
                    
                  <div class="accordion accordion-flush" id="filterAccordion">
                      <!-- Status Accordion -->
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="headingStatus">
                          <button
                            class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseStatus"
                            aria-expanded="true"
                            aria-controls="collapseStatus"
                          >
                          Status <span class="filter-cnt-subtotal filter-cnt-status">0</span>
                          </button>
                        </h2>
                        <div
                          id="collapseStatus"
                          class="accordion-collapse collapse"
                          aria-labelledby="headingStatus"
                        >
                          <div class="accordion-body">
                            <input
                              type="search"
                              id="statusSearch"
                              class="form-control form-control-sm mb-2"
                              placeholder="Search status"
                            />
                            <div id="statusFilters" class="form-check filter-list">
                              <!-- Checkboxes will be dynamically populated -->
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- Owner Accordion -->
                      <div class="accordion-item">
                          <h2 class="accordion-header" id="headingOwner">
                            <button
                              class="accordion-button collapsed"
                              type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#collapseOwner"
                              aria-expanded="true"
                              aria-controls="collapseOwner"
                            >
                            Owner <span class="filter-cnt-subtotal filter-cnt-owner">0</span>
                            </button>
                          </h2>
                          <div
                            id="collapseOwner"
                            class="accordion-collapse collapse"
                            aria-labelledby="headingOwner"
                          >
                            <div class="accordion-body">
                              <input
                                type="search"
                                id="ownerSearch"
                                class="form-control form-control-sm mb-2"
                                placeholder="Search owner"
                              />
                              <div id="ownerFilters" class="form-check filter-list">
                                <!-- Checkboxes will be dynamically populated -->
                              </div>
                            </div>
                          </div>
                      </div>
                      <!-- Client Accordion -->
                      <div class="accordion-item">
                          <h2 class="accordion-header" id="headingClient">
                            <button
                              class="accordion-button collapsed"
                              type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#collapseClient"
                              aria-expanded="true"
                              aria-controls="collapseClient"
                            >
                            Client <span class="filter-cnt-subtotal filter-cnt-client">0</span>
                            </button>
                          </h2>
                          <div
                            id="collapseClient"
                            class="accordion-collapse collapse"
                            aria-labelledby="headingClient"
                          >
                            <div class="accordion-body">
                              <input
                                type="search"
                                id="clientSearch"
                                class="form-control form-control-sm mb-2"
                                placeholder="Search client"
                              />
                              <div id="clientFilters" class="form-check filter-list">
                                <!-- Checkboxes will be dynamically populated -->
                              </div>
                            </div>
                          </div>
                      </div>
                  </div>
                </div>
              </div>
            </div>
            <table id="rfqListTable" class="table table-sm nowrap" width="100%">
              <!-- <thead>
              </thead>
              <tbody style="font-size:13px;">
              </tbody> -->
            </table>
            <div class="table-loading-spinner-container" style="height:100%;display:flex;align-items:center;justify-content:center;">
              <span class="spinner table-loading-spinner spinner-border spinner-border-sm spinner-busy" role="status" style="width: 2rem;height: 2rem;color: #475562;" aria-hidden="true"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- offCanvas -->
    <div class="offcanvas offcanvas-end" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasRightLabel">RFQ #<span id="offCanvasInsertRFQId"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <h6>Summary 
          <button id="copyCRMProject" class="btn btn-sm copy-crm-info" data-bs-toggle="tooltip" data-bs-placement="right" title="Copy CRM Info" type="button"><i class="bi bi-copy"></i></button>
        </h6>
        <table class="offcanvas-details-table table-sm">
          <tbody style="font-size:13px;">
            <tr>
              <th width="40%">Status</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>RFQ Date</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Owner</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Client</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Client name</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Project name</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Targeting condition</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Project type</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Total sales</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Total GM</th>
              <td>
                
              </td>
            </tr>
            <tr>
              <th>Total GM (%)</th>
              <td>
                
              </td>
            </tr>
            <!-- <tr>
              <th>CRM No.</th>
              <td class="position-relative">
                
              </td>
            </tr> -->
            <tr>
              <th>Notes</th>
              <td class="position-relative">
                
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="offcanvas-footer" align="right">
        <button id="loadAll" class="btn btn-primary" style="position:relative;font-size: 90% !important;width:100%;">
          <!-- <span class="spinner spinner-border spinner-border-sm" role="status" style="width: 1rem;height: 1rem;color: white;margin-right:5px;" aria-hidden="true"></span> -->
          <i class="bi bi-file-earmark-arrow-up"></i><span>&nbsp;Load RFQ</span>
        </button>
      </div>
    </div>

    {{FOOTER}}

    <!-- Warning Alert Popup -->
    <div class="modal fade" id="warningAlert" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="warningAlertLabel" aria-hidden="true">
      <div class="modal-dialog" style="max-width:450px;">
        <div class="modal-content shadow-lg" style="border-radius:10px;">
          <div class="modal-header" style="padding: 1rem 1rem 0.1rem 1rem;border-bottom: none;">
            <h5 class="modal-title" id="warningAlertLabel" style="font-size:18px;">Please check</h5>
          </div>
          <div class="modal-body" style="padding: 0.5rem 1rem 0.5rem 1rem;">
            <div id="alertMessage" style="font-size:14px;"></div>
          </div>
          <div class="modal-footer" style="padding: 1rem;border-top: none;">
            <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal" style="margin:0;padding-left:0.8rem;padding-right:0.8rem;">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirm Alert Popup -->
    <div class="modal fade" id="confirmAlert" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="confirmAlertLabel" aria-hidden="true">
      <div class="modal-dialog" style="max-width:450px;">
        <div class="modal-content shadow-lg" style="border-radius:10px;">
          <div class="modal-header" style="padding: 1rem 1rem 0.1rem 1rem;border-bottom: none;">
            <h5 class="modal-title" id="confirmAlertLabel" style="font-size:18px;">Please confirm</h5>
          </div>
          <div class="modal-body" style="padding: 0.5rem 1rem 0.5rem 1rem;">
            <div id="confirmMessage" style="font-size:14px;"></div>
          </div>
          <div class="modal-footer" style="padding: 1rem;border-top: none;">
            <button type="button" class="btn btn-sm modal-alert-btn-cancel" data-bs-dismiss="modal" style="margin:0;padding-left:0.8rem;padding-right:0.8rem;">Cancel</button>
            <button type="button" class="btn btn-primary btn-sm modal-alert-btn-confrim" data-bs-dismiss="modal" style="margin:0;padding-left:0.8rem;padding-right:0.8rem;">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Backdrop -->
    <div id="toastBackdrop" class="toast-backdrop d-none"></div>
    <!-- Success/Fail message popup -->
    <div class="toast-container position-fixed p-3" style="z-index: 9999; left: 50%; top: 5px;width:350px;margin-left:-175px;">
      <div id="successToast" class="toast fade shadow" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false" tabindex="-1"><!--data-bs-delay="3000"-->
        <div class="toast-header">
          <!-- <img src="..." class="rounded mr-2" alt="..."> -->
          <strong class="mr-auto" style="color:#00b5cb;font-size:115%;"><i class="bi bi-check2-circle"></i> Updated!</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" style="color:gray;font-size:90%;">
          <span id="successAlertType"></span> for <span style="font-weight:500">RFQ #<span id="successAlertId"></span></span> was updated successfully.
        </div>
      </div>
      <div id="failToast" class="toast fade shadow" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false" tabindex="-1">
        <div class="toast-header">
          <strong class="mr-auto" style="color:#cc2b4f;font-size:115%;"><i class="bi bi-exclamation-octagon"></i> Failed..</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" style="color:gray;font-size:90%;">
          <span class="fail-error-message"></span>
        </div>
      </div>
    </div>
    
    
    <!--jQuery & jQueryUI cdn -->
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js" integrity="sha256-J8ay84czFazJ9wcTuSDLpPmwpMXOm573OUtZHPQqpEU=" crossorigin="anonymous"></script>

    <!--bootstrap and popper cdn -->
    
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script> -->

    <!-- bootstrap select -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/js/bootstrap-select.min.js"></script> -->
    <!-- Latest compiled and minified JavaScript -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/i18n/defaults-*.min.js"></script> -->
    <?!= include('[JS]Bootstrap-Select.js'); ?>

    <!-- Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/v/bs5/dt-2.1.3/sl-2.0.4/datatables.min.js"></script>
    <!-- <script src="https://cdn.datatables.net/v/dt/dt-2.1.3/sl-2.0.4/datatables.min.js"></script> -->
    <script src="https://cdn.datatables.net/plug-ins/2.1.6/features/scrollResize/dataTables.scrollResize.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/5.0.1/js/dataTables.fixedColumns.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/5.0.1/js/fixedColumns.bootstrap5.js"></script>


    <!-- moment -->
    <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>

    <!-- Date Range Picker -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <?!= include('[JS]Navbar'); ?> <!--INCLUDE [JS]Navbar.html FILE-->

    <script>
      var rfq_id_val;
      var list_header;
      var table;

      google.script.run.withSuccessHandler(showRFQ).withFailureHandler(function (error) {
            console.error("Error in fetching RFQ data: ", error);
          }).getRFQ();

      

      function showRFQ(dataArray) {
        $(document).ready(function() {

          //console.log(dataArray);
          list_header = dataArray[0];

          var tableColumns = dataArray[0].map((str, index) => ({ title : str }));
          var tableData = dataArray.slice(1);

          // Populate Status, Owner, Client checkboxes dynamically
          var statusIdx = list_header.findIndex(val => val == 'Status'),
              ownerIdx = list_header.findIndex(val => val == 'Owner'),
              clientIdx = list_header.findIndex(val => val == 'Client'),
              dateIdx = list_header.findIndex(val => val == 'Date');

          //console.log(dataArray);


          // Initialize DataTable
          table = $('#rfqListTable').DataTable({
            data:tableData,
            columns:tableColumns,
            columnDefs: [	
              { 
                targets: list_header.findIndex(val => val == 'RFQ ID'),
                render : function ( data, type, row, meta ) {                  
                  return `<a class="rfq-id-link" data-bs-toggle="offcanvas" href="#offcanvasRight" role="button" aria-controls="offcanvasRight">${data}</a>`;
                }
              },
              { 
                targets: list_header.findIndex(val => val == 'Status'),
                render : function ( data, type, row, meta ) {   
                  var $select = $(`
                    <select class="rfq-data-status form-select form-select-sm" data-status="${data}" value="${data}">
                      <option value="">Choose</option>
                      <option value="Ordered">Ordered</option>
                      <option value="Failed">Failed</option>
                      <option value="Pending">Pending</option>
                      <option value="Pass">Pass</option>
                      <option value="Bidding">Bidding</option>
                      <option value="Delete">Delete</option>
                      <option value="Terminate">Terminate</option>
                    </select>`);
                  $select.find('option[value="'+data+'"]').attr('selected', 'selected');
                  return $select[0].outerHTML + '<span class="spinner spinner-border spinner-border-sm" role="status" style="width: 1rem;height: 1rem;color: #475562;" aria-hidden="true"></span>';
                },
                className : 'dt-center'
              }
            ],
            fixedColumns: {
                start: 2
            },
            language: { search: '', searchPlaceholder: "Search all" },
            search: { return: true },
            //order: [],
            order: [[0, 'desc']],
            scrollX: true,
            scrollResize: true,
            scrollCollapse: true,
            scrollY: 100,
            autoWidth: false,   // Disable auto width calculation to avoid issues with merged cells
            paging: true,
            pageLength: 25,
            //ordering: false,      // Disable ordering because of merged cells
            info: true,          // Disable table info to reduce DOM manipulation
            autoWidth: false,     // Disable automatic width adjustments
            destroy: true,        // Allow reinitialization without issues
            initComplete: function(settings, json) {
              $('.dt-search').prepend($('.filter-dropdown'));
              $('.dt-search').prepend($('#selectDateRange'));
              $('.dt-search').prepend($('.go-to-btn-container'));
              $('.filter-dropdown,#selectDateRange,.go-to-btn-container').toggleClass('d-none');
              //$('#rfqListTable_wrapper > div.row > div:nth-child(1)').hide();
              $('#rfqListTable_wrapper > div.row > div:nth-child(2)').removeClass('col-sm-12 col-md-6');
              
              $('.table-loading-spinner-container').toggleClass('d-none');
              $('.table-loading-spinner').toggleClass('spinner-busy');

              var this_table = this.api();
              //console.log(temp_table)
              function processColumnData(columnIdx, filterId, checkboxClass) {
                const uniqueArray = [];
                this_table.column(columnIdx).data().unique().each(function (value) {
                  // if (filterId == 'statusFilters') { 
                  //   console.log(value);
                  //   let elements = $(value);
                  //   value = $(elements[0]).attr('data-status');
                    
                  // }
                  if (value !== undefined) uniqueArray.push(value);
                });
                uniqueArray.sort().forEach(function (val) {
                  $(`#${filterId}`).append(`
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input ${checkboxClass}" id="${checkboxClass}-${val}" value="${val}">
                      <label class="form-check-label" for="${checkboxClass}-${val}">${val}</label>
                    </div>
                  `);
                });
              }
        
              // Process each column
              processColumnData(statusIdx, 'statusFilters', 'status-checkbox');
              processColumnData(ownerIdx, 'ownerFilters', 'owner-checkbox');
              processColumnData(clientIdx, 'clientFilters', 'client-checkbox');

              // 날짜 선택 범위 변경 이벤트 핸들러 함수 | Date range selection change event handler function
              function cb(startDate, endDate) {
                  $('#selectDateRange span').html(startDate.format('MMMM D, YYYY') + ' - ' + endDate.format('MMMM D, YYYY'));
              }

              // 날짜 범위 선택기 초기화 | Initialize date range picker
              $('#selectDateRange').daterangepicker({
                  startDate: startDate,
                  endDate: endDate,
                  "opens": "center",
                  ranges: {
                      'Today': [moment(), moment()],
                      'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                      'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                      'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                      'This Month': [moment().startOf('month'), moment().endOf('month')],
                      'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
                      'This Year' : [moment().startOf('year'), moment().endOf('year')]
                  }
              }, cb);

              // 초기 콜백 호출 | Initial callback invocation
              cb(startDate, endDate);


            }
          });

          

          // Define groups and their corresponding column indexes
          var groups = {
            status: { selector: '.status-checkbox', column: statusIdx },
            owner: { selector: '.owner-checkbox', column: ownerIdx },
            client: { selector: '.client-checkbox', column: clientIdx }
          };

          // Initialize the daterangepicker
          var dateRange = { start: startDate, end: endDate }; // Object to store the selected date range
          

          // Combined custom search logic for checkboxes and merged group search
          $.fn.dataTable.ext.search.push(function (settings, rowData, rowIndex) {
            var searchTerm = $('input#dt-search-0').val();

            //console.log(rowData);

            // Step 1: Handle checkbox filters
            var selectedFilters = {};
            Object.keys(groups).forEach(function (key) {
              var group = groups[key];
              selectedFilters[key] = $(group.selector + ':checked').map(function () {
                return this.value;
              }).get();
            });

            var isFilterApplied = Object.values(selectedFilters).some(function (values) {
              return values.length > 0;
            });

            var matchesFilters = Object.keys(selectedFilters).every(function (key) {
              var group = groups[key];
              var selectedValues = selectedFilters[key];

              //console.log(selectedValues);

              // Skip this filter if no values are selected for this group
              if (selectedValues.length === 0) return true;

              // Check if the cell value matches any of the selected values
              //var regex = new RegExp(selectedValues.join('|'));
              var regex = new RegExp(`^(${selectedValues.join('|')})$`);
              return regex.test(key === 'status' ? tableData[rowIndex][group.column]  : rowData[group.column]);
              //return regex.test(rowData[group.column]);
            });

            // Step 2: Handle search functionality
            var matchesSearch = !searchTerm || new RegExp(searchTerm, 'i').test(rowData);

            // Step 3: Handle date range filtering
            var matchesDateRange = true;
            if (dateRange.start && dateRange.end) {
              matchesDateRange = moment(rowData[dateIdx], 'M/D/YYYY').isBetween(dateRange.start, dateRange.end, 'day', '[]')
            }

            // Row is shown if it matches all criteria: filters, search term, and date range
            return (!isFilterApplied || matchesFilters) && matchesSearch && matchesDateRange;
          });
          

          $('#selectDateRange').on('show.daterangepicker', function(ev, picker) {
            $(this).addClass('show-date-picker');
          });

          $('#selectDateRange').on('hide.daterangepicker', function(ev, picker) {
            $(this).removeClass('show-date-picker');
          });

          // Event listener for checkboxes
          $(document).on('change', '.status-checkbox, .owner-checkbox, .client-checkbox', function () {
            const totalCnt = $('.filter-dropdown-menu .form-check-input:checked').length;
            const statusSubCnt = $('.filter-dropdown-menu .form-check-input.status-checkbox:checked').length;
            const ownerSubCnt = $('.filter-dropdown-menu .form-check-input.owner-checkbox:checked').length;
            const clientSubCnt = $('.filter-dropdown-menu .form-check-input.client-checkbox:checked').length;
            
            //console.log(totalCnt);
            $('.filter-dropdown .filter-cnt-status').text(statusSubCnt);
            $('.filter-dropdown .filter-cnt-owner').text(ownerSubCnt);
            $('.filter-dropdown .filter-cnt-client').text(clientSubCnt);
            $('.filter-cnt-total').text(totalCnt);
            table.draw(); // Trigger the custom filter
          });

          let debounceTimeout;
          // Search event listener for DataTables' dt-search
          $('input#dt-search-0').on('input', function (e) {
            clearTimeout(debounceTimeout); // Clear any pending redraw

            // Set a timeout to redraw the table after 300ms
            debounceTimeout = setTimeout(function () {
              table.draw(); // Perform search within the already filtered data
            }, 300); // Adjust delay time as needed (e.g., 200-500ms)

            if ($(this).val().length === 0){
              table.search('').draw();
            }
          });

          document.getElementById("dt-search-0").addEventListener("search", function(event) {
             table.search('').draw();
          });

          // Reset filters button
          $('#clearFilter').click(function () {
            $('.filter-dropdown-menu .form-check-input:checked').prop('checked', false).trigger('change'); // Uncheck all checkboxes
            table.draw(); // Reset table filter
          });

          // Search inside the accordion
          $('#statusSearch,#ownerSearch,#clientSearch').on('keyup', function () {
            var searchValue = $(this).val().toLowerCase();
            $(this).closest('.accordion-body').find('.form-check').each(function () {
              var label = $(this).find('label').text().toLowerCase();
              $(this).toggle(label.indexOf(searchValue) > -1); // Show/hide based on search
            });
          });

          // Update dateRange object when a range is selected
          $('#selectDateRange').on('apply.daterangepicker', function (ev, picker) {
            dateRange.start = picker.startDate;
            dateRange.end = picker.endDate;
            //$(this).val(picker.startDate.format('M/D/YYYY') + ' - ' + picker.endDate.format('M/D/YYYY'));
            table.draw(); // Redraw the table when the date range changes
          });

        });
      }

      function handleFormSubmit(formObject) {    
        // Google 스크립트 실행 | Execute Google script
        google.script.run
            .withFailureHandler(e => {
              // 실패 시 오류 메시지 표시 | Display error message on failure
              $('.fail-error-message').text(e.message);

              // 버튼 활성화 및 로딩 스피너 숨김 | Enable button and hide loading spinner
              $('select.rfq-data-status.d-none+.spinner-busy').toggleClass('spinner-busy');
              $('select.rfq-data-status.d-none').toggleClass('d-none');

              // 실패 메세지 표시 | Display failure message
              $('#failToast').toast('show');
            })
            .withSuccessHandler(e => {

              // 버튼 활성화 및 로딩 스피너 숨김 | Enable button and hide loading spinner
              $('select.rfq-data-status.d-none+.spinner-busy').toggleClass('spinner-busy');
              $('select.rfq-data-status.d-none').toggleClass('d-none');
              
              // 성공 메세지 표시 | Display success message
              $('#successToast').toast('show');

              setTimeout(function() {
                  $('#successToast').toast('hide');
              }, 3000);
              //console.log(e);
              
            })
            .doPost(formObject);
      }

      $(function(){
        $(document).on('mousedown','select.rfq-data-status', function(e){
          //e.preventDefault();
          if($('#offcanvasRight').hasClass('show')) {
            $('#offcanvasRight .btn-close').trigger('click');
          }

          $(this).one('change', function(){
            var selected_val = $(this).val();
            var rfq_id = $(this).closest('tr').find('td').eq(0).text().replace(/\s+/g, '');
            //var $activeRow = $('#rfqListTable tbody').find('.active-row td');
            //var rfq_id = $activeRow.eq(0).text().replace(/\s+/g, '');

            // console.log(selected_val);
            // console.log(rfq_id);

            $('#rfqId').val(rfq_id);
            $('#successAlertId').text(rfq_id);
            $('#successAlertType').text('Status');
            $('#rfqStatus').val(selected_val);
            $('#formType').val('update-status');
            $(this).closest('tr').find('td').eq(list_header.findIndex(val => val == 'Last updated')).text(moment().format('M/D/YYYY'));
            
            table.columns.adjust();
            $('#rfqStatusForm').submit();
            
            $(this).toggleClass('d-none');
            $(this).next().toggleClass('spinner-busy');
            $(this).attr('data-status', selected_val);

          });
          
        });

        $(document).on('click', '.rfq-id-link', function(e){
          //e.preventDefault();
          if($('#offcanvasRight').hasClass('show')) {
            $('#offcanvasRight').children().css('opacity','0');
            $('#offcanvasRight').one('hidden.bs.offcanvas', function(){
              //console.log(e.target);
              var offcanvas = new bootstrap.Offcanvas($('#offcanvasRight')[0]);
              // Show the offcanvas
              $('#offcanvasRight').children().css('opacity','1');
              offcanvas.show();
            });
          }
          
          $(this).closest('tbody').find('tr.active-row').removeClass('active-row');
          $(this).closest('tr').addClass('active-row');

          rfq_id_val = $(this).text().replace(/\s+/g, '');
          var $activeRow = $('#rfqListTable tbody').find('.active-row td');
          var $offcanvasTableTd = $('#offcanvasRight').find('.offcanvas-details-table tbody td');
          $offcanvasTableTd.html('');
          //var row_span = Number($activeRow.eq(0).attr('rowspan') || 1);

          var status_val = $activeRow.eq(list_header.findIndex(val => val == 'Status')).find('select.rfq-data-status').val();
          var date_val = $activeRow.eq(list_header.findIndex(val => val == 'Date')).text();
          var owner_val = $activeRow.eq(list_header.findIndex(val => val == 'Owner')).text();
          var client_val = $activeRow.eq(list_header.findIndex(val => val == 'Client')).text();
          var client_name_val = $activeRow.eq(list_header.findIndex(val => val == 'Client name')).text();
          var project_name_val = $activeRow.eq(list_header.findIndex(val => val == 'Project name (Mail title)')).text();
          var targeting_val = $activeRow.eq(list_header.findIndex(val => val == 'Targeting condition')).text();
          var project_type_val = $activeRow.eq(list_header.findIndex(val => val == 'Project type')).text();
          var sales_val = $activeRow.eq(list_header.findIndex(val => val == 'Expected sales (without tax)')).text();
          var gm_val = $activeRow.eq(list_header.findIndex(val => val == 'GM')).text();
          var gm_per_val = $activeRow.eq(list_header.findIndex(val => val == 'GM (%)')).text();
          //var crm_val = $activeRow.eq(list_header.findIndex(val => val == 'CRM No.')).html();
          var comments_val = $activeRow.eq(list_header.findIndex(val => val == 'Notes')).text();

          $('#offCanvasInsertRFQId').text(rfq_id_val);
          $offcanvasTableTd.eq(0).append(`<div class="rfq-data-status" data-status="${status_val}">${status_val}</div>`);
          //$offcanvasTableTd.eq(0).find('div.rfq-data-status').text(status_val);
          //$offcanvasTableTd.eq(0).find('div.rfq-data-status').attr('data-status',status_val);
          $offcanvasTableTd.eq(1).text(date_val);
          $offcanvasTableTd.eq(2).text(owner_val);
          $offcanvasTableTd.eq(3).text(client_val);
          $offcanvasTableTd.eq(4).text(client_name_val);
          $offcanvasTableTd.eq(5).text(project_name_val);
          $offcanvasTableTd.eq(6).text(targeting_val);
          $offcanvasTableTd.eq(7).text(project_type_val);
          $offcanvasTableTd.eq(8).text('₩ ' + sales_val);
          $offcanvasTableTd.eq(9).text('₩ ' + gm_val);
          $offcanvasTableTd.eq(10).text(gm_per_val + '%');
         
          $offcanvasTableTd.eq(11).append(`
          <textarea class="form-control form-control-sm textarea-readonly" id="rfqCommentsInput" rows="3" style="font-size:13px !important;width:83%;" placeholder="Notes" readonly>${comments_val}</textarea>
          <button class="btn btn-sm position-absolute edit-input-offcanvas" type="button"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm position-absolute d-none cancel-edit-offcanvas" type="button"><i class="bi bi-x-circle"></i></button>
          <button class="btn btn-sm position-absolute d-none save-edit-offcanvas" type="button"><i class="bi bi-check-circle"></i></button>`);
          
        });

        $(document).on('click', 'button.edit-input-offcanvas', function(e) {
            e.preventDefault();

            var $parent = $(this).closest('td');
            //var $input = $parent.find('input,textarea');
            var $input = $parent.find('textarea');
            var prevName = $input.val().trim();

            // Generic toggle function for enabling/disabling edit mode
            function toggleEditing(isEditing) {
                //$parent.find($input.attr('id').startsWith('crmNumber') ? '#crmNumberSpan' : '#rfqCommentsSpan').toggleClass('d-none', isEditing);
                //$parent.find('#rfqCommentsSpan').toggleClass('d-none', isEditing);
                //$input.toggleClass('d-none', !isEditing);
                $input.toggleClass('textarea-readonly', !isEditing);
                $input.prop('readonly', !isEditing);
                
                $parent.find('button.save-edit-offcanvas, button.cancel-edit-offcanvas').toggleClass('d-none', !isEditing);
                $parent.find('button.edit-input-offcanvas').toggleClass('d-none', isEditing);
                
                if (isEditing) {
                    $input.focus();
                    var tmpStr = $input.val();
                    $input.val('');
                    $input.val(tmpStr);
                }
            }

            toggleEditing(true);

            // Event handler for cancel action
            $parent.find('button.cancel-edit-offcanvas').off('click').on('click', function() {
                  $input.val(prevName);
                  toggleEditing(false);
            });

            $input.on('keyup', function(e) {
              if(e.key === 'Enter') {
                $parent.find('button.save-edit-offcanvas').trigger('click');
              }
            });

            // Event handler for save action
            $parent.find('button.save-edit-offcanvas').off('click').on('click', function() {
                var curName = $input.val().trim();
                var $activeRow = $('#rfqListTable tbody').find('.active-row td');
                var rfq_id = $activeRow.eq(0).text().replace(/\s+/g, '');

                $input.val(curName);
                toggleEditing(false);

                $('#rfqId').val(rfq_id);
                $('#successAlertId').text(rfq_id);


                //if($input.attr('id') === 'rfqCommentsInput') {
                  $('#rfqComments').val(curName);
                  $('#formType').val('update-comments');
                  $('#successAlertType').text('Notes');
                  //$('#rfqCommentsSpan').text(curName);
                  $activeRow.eq(list_header.findIndex(val => val == 'Notes')).text(curName);
                //}

                table.columns.adjust();
                $('#rfqStatusForm').submit();
                
            });


            $input.off('blur').on('blur', function(e) {
              //console.log(e.relatedTarget);
              if ($input.prop('readonly') == false) {
                if(!$(e.relatedTarget).hasClass('cancel-edit-offcanvas') && !$(e.relatedTarget).hasClass('save-edit-offcanvas')) {
                  $input.val(prevName);
                  toggleEditing(false);
                }
              }
            });


        });

        $(document).on('click', '#copyCRMProject', function(e){
          e.preventDefault();

          // var $offcanvas = $(this).closest('.offcanvas');
          // var $offcanvasTable = $offcanvas.find('table.offcanvas-details-table');
          var $activeRow = $('#rfqListTable tbody').find('.active-row td');
          var input_project_name = $activeRow.eq(list_header.findIndex(val => val == 'Project name (Mail title)')).text();
          var input_targeting_condition = $activeRow.eq(list_header.findIndex(val => val == 'Targeting condition')).text();
          var input_rfq_date = $activeRow.eq(list_header.findIndex(val => val == 'Date')).text();
          var input_status = $activeRow.eq(list_header.findIndex(val => val == 'Status')).find('select.rfq-data-status').val();
          var input_account_name = $activeRow.eq(list_header.findIndex(val => val == 'Client')).text();
          var input_client_name = $activeRow.eq(list_header.findIndex(val => val == 'Client name')).text();
          var input_owner_name = $activeRow.eq(list_header.findIndex(val => val == 'Owner')).text();
          var input_product_type = $activeRow.eq(list_header.findIndex(val => val == 'Project type')).text();
          var input_country = $activeRow.eq(list_header.findIndex(val => val == 'Country')).text();
          var input_requested_n = $activeRow.eq(list_header.findIndex(val => val == 'Requested N')).text();
          var input_cpi = $activeRow.eq(list_header.findIndex(val => val == 'CPI')).text().replace(/,/g , '');
          var input_ir = $activeRow.eq(list_header.findIndex(val => val == 'Estimate IR')).text().replace(/,/g , '');
          var input_loi = $activeRow.eq(list_header.findIndex(val => val == 'LOI')).text().replace(/,/g , '');
          var input_sales = $activeRow.eq(list_header.findIndex(val => val == 'Expected sales (without tax)')).text();
          var input_gm = $activeRow.eq(list_header.findIndex(val => val == 'GM')).text();
          var input_gm_per = $activeRow.eq(list_header.findIndex(val => val == 'GM (%)')).text();
          var copyScript = `
Status : ${input_status}
RFQ Date : ${input_rfq_date}
Owner :	${input_owner_name}
Client : ${input_account_name}
Client name : ${input_client_name}
Project name : ${input_project_name}
Targeting condition :	${input_targeting_condition}
Project type : ${input_product_type}
Country : ${input_country}
Requested N : ${input_requested_n}
CPI : ${input_cpi}
LOI : ${input_loi}
Total sales : ₩ ${input_sales}
Total GM : ₩ ${input_gm}
Total GM (%) : ${input_gm_per}%
`;

          navigator.clipboard.writeText(copyScript);

          $(this).attr('title', 'Copied!')
            // 툴팁 제목 수정 및 툴팁 표시 | Fix the tooltip title and show the tooltip
            .tooltip('_fixTitle')
            .tooltip('show')
            // 'copy-button'의 title 속성을 "Copy to Clipboard"으로 재설정 | Reset the 'title' attribute of 'copy-button' to "Copy to Clipboard"
            .attr('title', "Copy CRM Info")
            // 툴팁 제목 수정 | Fix the tooltip title
            .tooltip('_fixTitle');
        });

        $(document).on('click', '#loadAll', function(e){
            e.preventDefault();
            
            $('#loadAll .spinner').toggleClass('spinner-busy');
            google.script.run.withSuccessHandler(function(url){
                //console.log(url);
                // 현재 페이지 새로고침 | Refresh current page
                window.open(`${ url }?mode=Create-KR&rfqid=${ rfq_id_val }${ lang === 'en' ? '&lang=en' : '' }`,'_blank');
            }).getScriptURL();
        });
        
      });

      
    </script>
    
    <!--
    <?!= include('[JS]Functions(Common)'); ?> 
    <?!= include('[JS]Actions(Common)'); ?> 
    <?!= include('[JS]JavaScript(CreateOS)'); ?> 
    -->
  </body>
</html>