<script>

  //initLang();
  
  var krwRate = 0;
  var calcRowCnt = 1;
  var previousT;
  var previousS;
  var rfq_id_idx,date_idx,owner_idx,client_idx,client_name_idx,project_name_idx,country_idx;
  var calcResultArray = [];
  var otherFeeArray = [];
  var clientSearchArr = [];
  var otherOptionKorean = [];
  var otherOptionEnglish = [];
  var isLoaded = false;
  var loadInputOS = false;
  var selected_countries;
  var clientSelectEl;
  var countryListOptions = [];
  var vendorTableData = [];
  var vendorTableColumns = [];
  var calcTotalObj = {};
  rfqModeOS = rfqModeOS !== 'OS' ? '' : 'OS';


  google.script.run.withSuccessHandler(data => {
      managerName = data;
      $('#managerSelect'+rfqModeOS).val(managerName).change().selectpicker('refresh');
  }).withFailureHandler(function (error) {
    console.error("Error in fetching active user data: ", error);
  }).getActiveUserName();

  function showGmailEmails(data) {
    $(document).ready(function () {
      //console.log(loadInputOS);
      //console.log(data);
      //if(loadInputOS) { rfqModeOS = ''; }

      var mailSubjectArr = [];
      for(var i=0; i<data.length; i++){
        mailSubjectArr.push({label:data[i].subject + data[i].sender,value:data[i].subject,sender:data[i].sender,client:data[i].client});
      }
      //console.log(mailSubjectArr);
      $(document).on("keydown.autocomplete","[id^=projectName]",function(e){
      $(this).autocomplete({
        source: mailSubjectArr,
        position: { my: "left top+2", at: "left bottom"},
        scroll: true,
        create: function () {
            $(this).data('ui-autocomplete')._renderItem = function (ul, item) {
                return $('<li>')
                    .append('<div>' + item.value + '</div>')
                    .appendTo(ul);
            };
        },
        select: function(event, ui) {
          //console.log(clientSearchArr);
          $(this).closest('div.row').parent().find('[id^=picName]').val(ui.item.sender);

          var cliSearchIdx = ui.item.client == '' ? 0 : clientSearchArr.findIndex(a => a.toLowerCase().match(ui.item.client)) + 1;

          // 기존 선택을 해제하고 새로 추가된 옵션을 선택 | Deselect the existing selection and select the newly added option
          $(this).closest('div.row').parent().find('[id^=clientSelect]').find(":selected").prop('selected', false);
          $(this).closest('div.row').parent().find('[id^=clientSelect]').find('option').eq(cliSearchIdx).prop('selected', true);

          $(this).closest('div.row').parent().find('[id^=clientSelect]').selectpicker('refresh');

          $(this).closest('div.row').parent().find("[id^=projectName]").blur();
        }
      });
      });

      $('[id^=refreshGmail]').find('.spinner').removeClass('spinner-busy');
      $('[id^=refreshGmail]').find('.spinner+span').show();
    });
  }

  //// ADD HEADER IN OPTGROUP!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  /**
   * 이 기능은 client 데이터를 동적으로 드롭다운 목록에 로드합니다. | This function dynamically loads client data into a dropdown list.
   */
  function showClient(dataArray) {
    $(document).ready(function () {
        //if(loadInputOS) { rfqModeOS = ''; }
        const dataHeader = dataArray[0];
        const dataBody = dataArray.slice(1);

        let optGroup = '';
        let otherOption = '';

        // 셀렉트 피커 새로고침 | Refresh the select picker
        $('[id^=clientSelect],#clientGroup').selectpicker('refresh');

        for (var i = 0; i < dataHeader.length; i++) {
          optGroup = optGroup + `<optgroup label="${ dataHeader[i] }"></optgroup>`;
          otherOption = otherOption + `<option>${ dataHeader[i] }</option>`;
        }

        $('[id^=clientSelect]').prepend(optGroup);
        $('#clientGroup').prepend(otherOption);

        // dataArray를 순회하면서 client 추가 | Iterate through dataArray and add clients
        for (var i = 0; i < dataBody.length; i++) {
            for (var j = 0; j < dataBody[i].length; j++) {
                clientSearchArr.push(dataBody[i][j][1]);

                // i번째 optgroup에 client 추가 | Add clients to the i-th optgroup
                $('[id^=clientSelect]').find('optgroup').eq(i).append('<option data-tokens="' + dataBody[i][j][1] + '" value="' + dataBody[i][j][0] + '">' + dataBody[i][j][0] + '</option>');
                
            }
        }

        // 셀렉트 피커 새로고침 | Refresh the select picker
        $('[id^=clientSelect],#clientGroup').selectpicker('refresh');
    });
  }

  /**
   * 이 기능은 CPI 데이터를 가져와서 loi, ir, client 를 입력할 때마다 CPI를 자동으로 계산합니다. | This function retrieves CPI data and automatically calculates CPI each time loi, ir, or client is entered.
   */
  function showRate(dataArray){
    $(document).ready(function(){
        //console.log(dataArray);
        // loiInput, irInput 입력 시 AutoFillCPI 함수 호출 | Call AutoFillCPI function when loiInput or irInput is entered
        $('#loiInput,#irInput').on('input',function(){
            AutoFillCPI(dataArray);
            AutoFillSOP_1CPI(dataArray);
            AutoFillSOP_2CPI(dataArray);
        });

        $('.sop-checkbox-option').each(function(index){
          $(this).on('change',function(){
            if($(this).is(':checked')) {
              if ($(this).val() == 'SOP_1') {
                AutoFillSOP_1CPI(dataArray);
              }
              if ($(this).val() == 'SOP_2') {
                AutoFillSOP_2CPI(dataArray);
              }
            }
          });
        });

        // clientSelect, countrySelect 변경 시 AutoFillCPI 함수 호출 | Call AutoFillCPI function when clientSelect or countrySelect changes
        $('#clientSelect,#countrySelect').on('change',function(){
            AutoFillCPI(dataArray);
            AutoFillSOP_1CPI(dataArray);
            AutoFillSOP_2CPI(dataArray);
        });

        $('#clientSelect').selectpicker().on('refreshed.bs.select', function(e) {
            AutoFillCPI(dataArray);
            AutoFillSOP_1CPI(dataArray);
            AutoFillSOP_2CPI(dataArray);
        });
    });
  }

  /**
   * 이 기능은 완료 포인트 데이터를 가져와서 loi 를 입력할 때마다 완료 포인트를 자동으로 계산합니다. | This function retrieves comp point data and automatically calculates comp point each time loi is entered.
   */
  function showCompPt(dataArray){
    $(document).ready(function(){
      
        // loiInput 입력 시 이벤트 핸들러 | Event handler when loiInput is entered
        $('#loiInput').on('input',function(e){
            // loiInput의 입력값을 정수로 변환 | Convert the input value of loiInput to an integer
            var input_loi = parseInt($('#loiInput').val().replace(/,/g , ''),10);

            // 입력값이 숫자가 아닌 경우 compPt를 빈 값으로 설정 | If the input value is not a number, set compPt to an empty value
            if(isNaN(input_loi)){
                $('#compPt').val('');
            } else {
                // compPt 테두리 강조 및 입력값에 따라 compPt 설정 | Highlight compPt border and set compPt according to the input value
                FlashBorder('#compPt');
                if(input_loi > 60) {
                    $('#compPt').val(AddComma(dataArray[59][1]));
                } else {
                    $('#compPt').val(AddComma(dataArray[input_loi][1]));
                }
            }
        });
    });
  }

  /**
   * 이 기능은 운영비 데이터를 가져와서 운영비 체크박스를 추가하고, 항목을 선택할 때마다 운영비를 자동으로 계산합니다. | This function fetches other fees data, adds other fees checkboxes, and automatically calculates other fees costs each time an item is selected.
   */
  function showOtherFee(dataArray){
    $(document).ready(function(){

      //if(loadInputOS) { rfqModeOS = ''; }
      
      var cnt = 1;
      // 옵션 배열 초기화 | Initialize option arrays
      for(var i=0; i<dataArray.length; i++){
        for(var j=0; j<dataArray[i].length; j++){
          // 운영비 비용 추가 | Add cost of other fees
          otherFeeArray.push(parseInt(dataArray[i][j][2].replace(/,/g , ''),10));
          // 한국어 운영비 옵션 추가 | Add Korean option
          otherOptionKorean.push(dataArray[i][j][0]);
          // 영어 운영비 옵션 추가 | Add English option
          otherOptionEnglish.push(dataArray[i][j][1]);

          if(rfqModeOS == 'OS') {
          // HTML에 체크박스 및 레이블 추가 | Add checkboxes and labels to HTML
            selected_countries.forEach(function(ctry,idx){
              $('#otherFeeTable-' + ctry).find('.checkbox-option-label').eq(i).next().append('<div class="form-check form-check-inline">'
                        +'<input type="checkbox" class="form-check-input checkbox-option" id="otherFee'+ cnt + '-' + ctry +'" value="'+ dataArray[i][j][0] +'">'
                        +'<label class="form-check-label other-fee-label" lang="ko" for="otherFee'+ cnt + '-' + ctry +'">'+dataArray[i][j][0]+'</label>'
                        +'<label class="form-check-label other-fee-label" lang="en" for="otherFee'+ cnt + '-' + ctry +'">'+dataArray[i][j][1]+'</label>'
                      +'</div>');
            });
          } else {
            $('.checkbox-option-label').eq(i).next().append('<div class="form-check form-check-inline">'
                        +'<input type="checkbox" class="form-check-input checkbox-option" id="otherFee'+ cnt +'" value="'+ dataArray[i][j][0] +'">'
                        +'<label class="form-check-label other-fee-label" lang="ko" for="otherFee'+ cnt +'">'+dataArray[i][j][0]+'</label>'
                        +'<label class="form-check-label other-fee-label" lang="en" for="otherFee'+ cnt +'">'+dataArray[i][j][1]+'</label>'
                      +'</div>');
          }
          cnt++;
        }
      }
      // 언어 설정에 따라 레이블 숨김 | Hide labels based on language setting
      if(lang == "ko" || lang == ""){ $('.other-fee-label[lang="en"]').hide(); }
      if(lang == "en"){ $('.other-fee-label[lang="ko"]').hide(); }
      
      // 체크박스 변경 이벤트 설정 | Set checkbox change events
      //$('.checkbox-option').each(function(){
        $(document).on('change', '.checkbox-option', function(){
          var index = $(this).closest('[id^=otherFeeTable]').find('.checkbox-option').index($(this));
          console.log(index);
          var $operationCostEl = $(this).closest('[id^=otherFeeBox]').parent().find('[id^=operationCost]');
          FlashBorder('#' + $operationCostEl.attr('id'));
          var otherFee = $operationCostEl.val() === "" ? 0 : parseInt($operationCostEl.val().replace(/,/g , ''),10);
          // 체크 여부에 따라 운영비 비용 추가 또는 제거 | Add or subtract other fees based on checkbox status
          if($(this).is(':checked')) {
            $operationCostEl.val(AddComma(otherFee + otherFeeArray[index]));
          } else {
            if(otherFee - otherFeeArray[index] <= 0){
              $operationCostEl.val('');
            } else{
              $operationCostEl.val(AddComma(otherFee - otherFeeArray[index]));
            }
          }
        });
      
      //});
    });

  }

  /**
   * 이 기능은 파트너 이용 비용 계산을 처리하도록 설계되었습니다. 최대 3개의 협력사를 추가할 수 있으며, 부족 샘플수, 3rd party CPI, 3rd party 운영비가 입력되면 3rd party 비용이 자동으로 계산됩니다. | This function is designed for handling partner costs calculations. You can add up to 3 partners, and when Needed N, 3rd party CPI, 3rd party fee are entered, 3rd party costs is calculated automatically.
   */
  function CalculatePartnerCost(){

    // 샘플 수 및 가능 수 값이 비어 있지 않은 경우 | If the values of sampleNum and possibleNum are not empty
    if($('#sampleNum').val() !== "" && $('#possibleNum').val() !== ""){
      // 필요한 값 1 계산 | Calculate needed value 1
      var needed_val_1 = parseInt($('#sampleNum').val().replace(/,/g , ''),10) - parseInt($('#possibleNum').val().replace(/,/g , ''),10);
      
      // 필요한 값이 0이면 샘플 차이 1을 비움, 그렇지 않으면 값을 설정하고 플래시 경계를 표시 | If needed value is 0, clear sample difference 1, otherwise set the value and show flash border
      if(needed_val_1 === 0){
        $('#sampleDiff_1').val('');
      } else {
        FlashBorder('#sampleDiff_1');
        $('#sampleDiff_1').val(AddComma(needed_val_1));
      }
    } 

    // sampleNum 및 possibleNum의 입력 이벤트에 대한 핸들러 설정 | Set handlers for input events on sampleNum and possibleNum
    $('#sampleNum,#possibleNum').on('input',function(){
      // 샘플 수 및 가능 수 값이 비어 있지 않은 경우 | If the values of sampleNum and possibleNum are not empty
      if($('#sampleNum').val() !== "" && $('#possibleNum').val() !== ""){
        // 필요한 값 1 계산 | Calculate needed value 1
        var needed_val_1 = parseInt($('#sampleNum').val().replace(/,/g , ''),10) - parseInt($('#possibleNum').val().replace(/,/g , ''),10);
        // 필요한 값이 0이면 샘플 차이 1을 비움, 그렇지 않으면 값을 설정하고 플래시 경계를 표시 | If needed value is 0, clear sample difference 1, otherwise set the value and show flash border
        if(needed_val_1 === 0){
          $('#sampleDiff_1').val('');
        } else {
          FlashBorder('#sampleDiff_1');
          $('#sampleDiff_1').val(AddComma(needed_val_1));
        }
        // 다른 필드들을 초기화 | Reset other fields
        $('#sampleDiff_2').val('');
        $('#sampleDiff_3').val('');
        $('#3rdpartyCost_2').val("");
        $('#3rdpartyCost_3').val("");
      } else {
        // 필요한 값이 비어 있으면 모든 필드를 초기화 | If needed value is empty, reset all fields
        $('#sampleDiff_1').val('');
        $('#sampleDiff_2').val('');
        $('#sampleDiff_3').val('');
        $('#3rdpartyCost_1').val("");
        $('#3rdpartyCost_2').val("");
        $('#3rdpartyCost_3').val("");
      }

      // 샘플 차이 1, 2, 3 및 제3자 비용 1, 2, 3을 계산 | Calculate sample differences 1, 2, 3 and third-party costs 1, 2, 3
      if($('#sampleDiff_1').val() !== "" && $('#3rdpartyCPI_1').val() !== "" && $('#3rdpartyOperation_1').val() !== ""){
        FlashBorder('#3rdpartyCost_1');
        $('#3rdpartyCost_1').val(AddComma((parseInt($('#sampleDiff_1').val().replace(/,/g , ''),10) * parseInt($('#3rdpartyCPI_1').val().replace(/,/g , ''),10)) + parseInt($('#3rdpartyOperation_1').val().replace(/,/g , ''),10)));
      }
      if($('#sampleDiff_2').val() !== "" && $('#3rdpartyCPI_2').val() !== "" && $('#3rdpartyOperation_2').val() !== ""){
        FlashBorder('#3rdpartyCost_2');
        $('#3rdpartyCost_2').val(AddComma((parseInt($('#sampleDiff_2').val().replace(/,/g , ''),10) * parseInt($('#3rdpartyCPI_2').val().replace(/,/g , ''),10)) + parseInt($('#3rdpartyOperation_2').val().replace(/,/g , ''),10)));
      }
      if($('#sampleDiff_3').val() !== "" && $('#3rdpartyCPI_3').val() !== "" && $('#3rdpartyOperation_3').val() !== ""){
        FlashBorder('#3rdpartyCost_3');
        $('#3rdpartyCost_3').val(AddComma((parseInt($('#sampleDiff_3').val().replace(/,/g , ''),10) * parseInt($('#3rdpartyCPI_3').val().replace(/,/g , ''),10)) + parseInt($('#3rdpartyOperation_3').val().replace(/,/g , ''),10)));
      }
    });

    // sampleDiff_1에 대한 입력 이벤트 핸들러 설정 | Set input event handler for sampleDiff_1
    $('#sampleDiff_1').on('input',function(){
      // sampleDiff_1이 비어 있으면 모든 필드를 초기화하고 함수 종료 | If sampleDiff_1 is empty, reset all fields and exit the function
      if($('#sampleDiff_1').val() == ""){
        $('#3rdpartyCost_1').val("");
        $('#sampleDiff_2').val("");
        $('#sampleDiff_3').val("");
        $('#3rdpartyCost_2').val("");
        $('#3rdpartyCost_3').val("");
        return false;
      }

      // 샘플 수 및 가능 수 값이 비어 있지 않은 경우 | If the values of sampleNum and possibleNum are not empty
      if($('#sampleNum').val() !== "" && $('#possibleNum').val() !== ""){
        // 필요한 값 2 계산 | Calculate needed value 2
        var needed_val_2 = parseInt($('#sampleNum').val().replace(/,/g , ''),10) - parseInt($('#possibleNum').val().replace(/,/g , ''),10) - parseInt($('#sampleDiff_1').val().replace(/,/g , ''),10);
        
        // 필요한 값이 0이면 샘플 차이 2를 비움, 그렇지 않으면 값을 설정하고 플래시 경계를 표시 | If needed value is 0, clear sample difference 2, otherwise set the value and show flash border
        if(needed_val_2 === 0){
          $('#sampleDiff_2').val('');
        } else {
          FlashBorder('#sampleDiff_2');
          $('#sampleDiff_2').val(AddComma(needed_val_2));
        }
      }

      // 샘플 차이 1, 2, 3 및 제3자 비용 1, 2, 3을 계산 | Calculate sample differences 1, 2, 3 and third-party costs 1, 2, 3
      if($('#sampleDiff_1').val() !== "" && $('#3rdpartyCPI_1').val() !== "" && $('#3rdpartyOperation_1').val() !== ""){
        FlashBorder('#3rdpartyCost_1');
        $('#3rdpartyCost_1').val(AddComma((parseInt($('#sampleDiff_1').val().replace(/,/g , ''),10) * parseInt($('#3rdpartyCPI_1').val().replace(/,/g , ''),10)) + parseInt($('#3rdpartyOperation_1').val().replace(/,/g , ''),10)));
      }
      if($('#sampleDiff_2').val() !== "" && $('#3rdpartyCPI_2').val() !== "" && $('#3rdpartyOperation_2').val() !== ""){
        $('#3rdpartyCost_2').val(AddComma((parseInt($('#sampleDiff_2').val().replace(/,/g , ''),10) * parseInt($('#3rdpartyCPI_2').val().replace(/,/g , ''),10)) + parseInt($('#3rdpartyOperation_2').val().replace(/,/g , ''),10)));
      }
      if($('#sampleDiff_3').val() !== "" && $('#3rdpartyCPI_3').val() !== "" && $('#3rdpartyOperation_3').val() !== ""){
        $('#3rdpartyCost_3').val(AddComma((parseInt($('#sampleDiff_3').val().replace(/,/g , ''),10) * parseInt($('#3rdpartyCPI_3').val().replace(/,/g , ''),10)) + parseInt($('#3rdpartyOperation_3').val().replace(/,/g , ''),10)));
      }
    });

    // sampleDiff_2에 대한 입력 이벤트 핸들러 설정 | Set input event handler for sampleDiff_2
    $('#sampleDiff_2').on('input',function(){
      // sampleDiff_2가 비어 있으면 모든 필드를 초기화하고 함수 종료 | If sampleDiff_2 is empty, reset all fields and exit the function
      if($('#sampleDiff_2').val() == ""){
        $('#3rdpartyCost_2').val("");
        $('#sampleDiff_3').val("");
        $('#3rdpartyCost_3').val("");
        return false;
      }

      // 샘플 수 및 가능 수 값이 비어 있지 않은 경우 | If the values of sampleNum and possibleNum are not empty
      if($('#sampleNum').val() !== "" && $('#possibleNum').val() !== ""){
        // 필요한 값 3 계산 | Calculate needed value 3
        var needed_val_3 = parseInt($('#sampleNum').val().replace(/,/g , ''),10) - parseInt($('#possibleNum').val().replace(/,/g , ''),10) - parseInt($('#sampleDiff_1').val().replace(/,/g , ''),10) - parseInt($('#sampleDiff_2').val().replace(/,/g , ''),10);
        
        // 필요한 값이 0이면 샘플 차이 3를 비움, 그렇지 않으면 값을 설정하고 플래시 경계를 표시 | If needed value is 0, clear sample difference 3, otherwise set the value and show flash border
        if(needed_val_3 === 0){
          $('#sampleDiff_3').val('');
        } else {
          FlashBorder('#sampleDiff_3');
          $('#sampleDiff_3').val(AddComma(needed_val_3));
        }
      }

      // 샘플 차이 1, 2, 3 및 제3자 비용 1, 2, 3을 계산 | Calculate sample differences 1, 2, 3 and third-party costs 1, 2, 3
      if($('#sampleDiff_1').val() !== "" && $('#3rdpartyCPI_1').val() !== "" && $('#3rdpartyOperation_1').val() !== ""){
        $('#3rdpartyCost_1').val(AddComma((parseInt($('#sampleDiff_1').val().replace(/,/g , ''),10) * parseInt($('#3rdpartyCPI_1').val().replace(/,/g , ''),10)) + parseInt($('#3rdpartyOperation_1').val().replace(/,/g , ''),10)));
      }
      if($('#sampleDiff_2').val() !== "" && $('#3rdpartyCPI_2').val() !== "" && $('#3rdpartyOperation_2').val() !== ""){
        FlashBorder('#3rdpartyCost_2');
        $('#3rdpartyCost_2').val(AddComma((parseInt($('#sampleDiff_2').val().replace(/,/g , ''),10) * parseInt($('#3rdpartyCPI_2').val().replace(/,/g , ''),10)) + parseInt($('#3rdpartyOperation_2').val().replace(/,/g , ''),10)));
      }
      if($('#sampleDiff_3').val() !== "" && $('#3rdpartyCPI_3').val() !== "" && $('#3rdpartyOperation_3').val() !== ""){
        $('#3rdpartyCost_3').val(AddComma((parseInt($('#sampleDiff_3').val().replace(/,/g , ''),10) * parseInt($('#3rdpartyCPI_3').val().replace(/,/g , ''),10)) + parseInt($('#3rdpartyOperation_3').val().replace(/,/g , ''),10)));
      }
    });

    // sampleDiff_3에 대한 입력 이벤트 핸들러 설정 | Set input event handler for sampleDiff_3
    $('#sampleDiff_3').on('input', function() {
      // sampleDiff_3이 비어 있으면 제3자 비용 3을 비움 | If sampleDiff_3 is empty, clear third-party cost 3
      if ($('#sampleDiff_3').val() == "") {
        $('#3rdpartyCost_3').val("");
        return false;
      }
      // sampleDiff_1, 2 및 3에 대한 값이 존재하고, 제3자 비용, CPI 및 운영 비용이 존재하는 경우 계산 및 플래시 경계 표시
      if ($('#sampleDiff_1').val() !== "" && $('#3rdpartyCPI_1').val() !== "" && $('#3rdpartyOperation_1').val() !== "") {
        $('#3rdpartyCost_1').val(AddComma((parseInt($('#sampleDiff_1').val().replace(/,/g, ''), 10) * parseInt($('#3rdpartyCPI_1').val().replace(/,/g, ''), 10)) + parseInt($('#3rdpartyOperation_1').val().replace(/,/g, ''), 10)));
      }
      if ($('#sampleDiff_2').val() !== "" && $('#3rdpartyCPI_2').val() !== "" && $('#3rdpartyOperation_2').val() !== "") {
        $('#3rdpartyCost_2').val(AddComma((parseInt($('#sampleDiff_2').val().replace(/,/g, ''), 10) * parseInt($('#3rdpartyCPI_2').val().replace(/,/g, ''), 10)) + parseInt($('#3rdpartyOperation_2').val().replace(/,/g, ''), 10)));
      }
      if ($('#sampleDiff_3').val() !== "" && $('#3rdpartyCPI_3').val() !== "" && $('#3rdpartyOperation_3').val() !== "") {
        FlashBorder('#3rdpartyCost_3');
        $('#3rdpartyCost_3').val(AddComma((parseInt($('#sampleDiff_3').val().replace(/,/g, ''), 10) * parseInt($('#3rdpartyCPI_3').val().replace(/,/g, ''), 10)) + parseInt($('#3rdpartyOperation_3').val().replace(/,/g, ''), 10)));
      }
    });

    // 1, 2 및 3에 대한 제3자 CPI 및 운영 비용에 대한 입력 이벤트 핸들러 설정 | Set input event handler for third-party CPI and operation costs for 1, 2, and 3
    $('#3rdpartyCPI_1,#3rdpartyCPI_2,#3rdpartyCPI_3,#3rdpartyOperation_1,#3rdpartyOperation_2,#3rdpartyOperation_3').on('input', function() {
      // ID에서 1, 2 또는 3을 추출하고 해당하는 제3자 비용의 플래시 경계를 표시 | Extract 1, 2, or 3 from the ID and flash the border for the corresponding third-party cost
      if (parseInt($(this).attr('id').split('_')[1], 10) == 1) { if ($('#3rdpartyCost_1').val() !== 0) { FlashBorder('#3rdpartyCost_1'); } }
      if (parseInt($(this).attr('id').split('_')[1], 10) == 2) { if ($('#3rdpartyCost_2').val() !== 0) { FlashBorder('#3rdpartyCost_2'); } }
      if (parseInt($(this).attr('id').split('_')[1], 10) == 3) { if ($('#3rdpartyCost_3').val() !== 0) { FlashBorder('#3rdpartyCost_3'); } }
      
      // sampleDiff_1, 2 및 3에 대한 값이 존재하고, 제3자 비용, CPI 및 운영 비용이 존재하는 경우 계산
      if ($('#sampleDiff_1').val() !== "" && $('#3rdpartyCPI_1').val() !== "" && $('#3rdpartyOperation_1').val() !== "") {
        $('#3rdpartyCost_1').val(AddComma((parseInt($('#sampleDiff_1').val().replace(/,/g, ''), 10) * parseInt($('#3rdpartyCPI_1').val().replace(/,/g, ''), 10)) + parseInt($('#3rdpartyOperation_1').val().replace(/,/g, ''), 10)));
      } else {
        $('#3rdpartyCost_1').val("");
      }
      if ($('#sampleDiff_2').val() !== "" && $('#3rdpartyCPI_2').val() !== "" && $('#3rdpartyOperation_2').val() !== "") {
        $('#3rdpartyCost_2').val(AddComma((parseInt($('#sampleDiff_2').val().replace(/,/g, ''), 10) * parseInt($('#3rdpartyCPI_2').val().replace(/,/g, ''), 10)) + parseInt($('#3rdpartyOperation_2').val().replace(/,/g, ''), 10)));
      } else {
        $('#3rdpartyCost_2').val("");
      }
      if ($('#sampleDiff_3').val() !== "" && $('#3rdpartyCPI_3').val() !== "" && $('#3rdpartyOperation_3').val() !== "") {
        $('#3rdpartyCost_3').val(AddComma((parseInt($('#sampleDiff_3').val().replace(/,/g, ''), 10) * parseInt($('#3rdpartyCPI_3').val().replace(/,/g, ''), 10)) + parseInt($('#3rdpartyOperation_3').val().replace(/,/g, ''), 10)));
      } else {
        $('#3rdpartyCost_3').val("");
      }
    });

  }

  function CalculateSOP_1Cost() {
    $('#sop_1Needed,#sop_1CPI').on('input change',function(){
      if ($('#sop_1Needed').val() !== "" && $('#sop_1CPI').val() !== "") {
        FlashBorder('#sop_1Cost');
        $('#sop_1Cost').val(AddComma(parseInt($('#sop_1Needed').val().replace(/,/g, ''),10) * parseInt($('#sop_1CPI').val().replace(/,/g, ''),10)));
      }
    });
  }

  function CalculateSOP_2Cost() {
    $('#sop_2Needed,#sop_2CPI').on('input change',function(){
      if ($('#sop_2Needed').val() !== "" && $('#sop_2CPI').val() !== "") {
        FlashBorder('#sop_2Cost');
        $('#sop_2Cost').val(AddComma(parseInt($('#sop_2Needed').val().replace(/,/g, ''),10) * parseInt($('#sop_2CPI').val().replace(/,/g, ''),10)));
      }
    });
  }

  /**
   * 이 기능은 다양한 조건과 사용자 입력을 기반으로 CPI 값을 자동으로 넣어줍니다. | This function handles the automatic filling of the CPI value based on various conditions and user inputs. 
   */
  function AutoFillCPI(dataArray) {
    // 입력된 LOI 및 IR 값 가져오기 | Get the entered LOI and IR values
    var input_loi = parseInt($('#loiInput').val().replace(/,/g, ''), 10);
    var input_ir = parseInt($('#irInput').val().replace(/,/g, ''), 10);
    var select_client = $('#clientSelect').val();
    var obey_country_group = parseInt($('#countrySelect').find(':selected').attr('class').split('_')[1], 10);

    // 초기화할 변수들 | Variables to be initialized
    var val_cli = 0;
    var val_loi = 0;
    var val_ir = 0;

    // 입력된 IR 값이 0~100 범위를 벗어날 경우 입련칸 아래에 팝업 경고 메세지 보여줌 | If the entered IR value is outside the range of 0 to 100, a popup warning message is displayed below the input field.
    if (input_ir > 100 || input_ir < 0) {
        $('.invalid-tooltip-ir').addClass('d-block');
        $('#irInput').val('');
        $('#cpiValue,#actualCPI,#sop_1CPI').val('');
        $('.showActualCPI').text('');
        $('.showSOP_1CPI').text('');
        $('.showSOP_2CPI').text('');
    } else {
        $('.invalid-tooltip-ir').removeClass('d-block');
    }

    // IR, LOI, 클라이언트 선택 여부 확인 | Check if IR, LOI, and client are selected
    if (isNaN(input_ir) || isNaN(input_loi) || select_client == "") {
        $('#cpiValue,#actualCPI,#sop_1CPI,#sop_2CPI').val('');
        $('.showActualCPI').text('');
        $('.showSOP_1CPI').text('');
        $('.showSOP_2CPI').text('');
    } else {
        // 클라이언트와 LOI에 따라 단가표의 index 값 설정 | Set index values of the ratecard based on the client and LOI
        if (select_client !== "") {
            
                val_cli = $('#clientSelect').find(':selected').parent().index() - 1;
                // 입력된 LOI 값을 기반으로 단가표의 해당하는 LOI 범위의 index 값 설정 (클라이언트가 sop_2가 아닌 경우) | Set the index value of the corresponding LOI range in the ratecard based on the entered LOI value. (If client is not sop_2)
                if (input_loi <= 5) { val_loi = 0; }
                if (input_loi >= 6 && input_loi <= 10) { val_loi = 1; }
                if (input_loi >= 11 && input_loi <= 15) { val_loi = 2; }
                if (input_loi >= 16 && input_loi <= 20) { val_loi = 3; }
                if (input_loi >= 21 && input_loi <= 25) { val_loi = 4; }
                if (input_loi >= 26 && input_loi <= 30) { val_loi = 5; }
                if (input_loi >= 31 && input_loi <= 35) { val_loi = 6; }
                if (input_loi >= 36 && input_loi <= 40) { val_loi = 7; }
                if (input_loi >= 41 && input_loi <= 45) { val_loi = 8; }
                if (input_loi >= 46 && input_loi <= 50) { val_loi = 9; }
                if (input_loi >= 51 && input_loi <= 55) { val_loi = 10; }
                if (input_loi >= 56) { val_loi = 11; }
            

            // 입력된 IR 값을 기반으로 단가표의 해당하는 IR 범위의 index 값 설정 | Set the index value of the corresponding IR range in the ratecard based on the entered IR value. 
            if (input_ir >= 80) { val_ir = 0; }
            if (input_ir >= 60 && input_ir <= 79) { val_ir = 1; }
            if (input_ir >= 40 && input_ir <= 59) { val_ir = 2; }
            if (input_ir >= 30 && input_ir <= 39) { val_ir = 3; }
            if (input_ir >= 20 && input_ir <= 29) { val_ir = 4; }
            if (input_ir >= 15 && input_ir <= 19) { val_ir = 5; }
            if (input_ir >= 10 && input_ir <= 14) { val_ir = 6; }
            if (input_ir >= 8 && input_ir <= 9) { val_ir = 7; }
            if (input_ir >= 6 && input_ir <= 7) { val_ir = 8; }
            if (input_ir >= 5 && input_ir < 6) { val_ir = 9; }
            if (input_ir >= 4 && input_ir < 5) { val_ir = 10; }
            if (input_ir >= 3 && input_ir < 4) { val_ir = 11; }
            if (input_ir >= 2 && input_ir < 3) { val_ir = 12; }
            if (input_ir >= 0 && input_ir < 2) { val_ir = 13; }

            // 선택된 클라이언트 그룹, 위에서 설정된 LOI & IR의 index 값을 기반으로 CPI 계산 | Calculate CPI value based on the selected client group and the previously set indices for LOI and IR
            var cpiValue = parseInt(dataArray[val_cli][val_loi][val_ir].replace(/,/g, ''), 10);

            // 조건에 따라 CPI 값 표시 및 설정 | Display and set CPI value based on conditions
            if (((input_loi >= 0 && input_loi <= 60)) && ((input_ir >= 0 && input_ir <= 100)) && ($('#countrySelect').val())) {

                // 입력값의 테두리에 플래시 효과 추가 | Flash border effect on the input value
                FlashBorder('#cpiValue');

                // CPI 관련 값 업데이트 | Update CPI-related values
                $('.showActualCPI').text(AddComma(cpiValue));
                $('#actualCPI').val(AddComma(cpiValue));
                $('#cpiValue').val(AddComma(cpiValue));

                // 특수패널 및 검증문항 선택에 따라 CPI 값 조정 | Adjust CPI value based on Specific age grp and trap question selections
                if ($('#specialPanel').find(':selected').index() == 2 || $('#specialPanel').find(':selected').index() == 3) {
                    // 특수패널에서 선택한 옵션이 2번이거나 3번일 경우 CPI에 1000을 더함 | If the selected option in the Specific age grp is 2 or 3, add 1000 to the CPI
                    $('.showActualCPI').text(AddComma(cpiValue));
                    $('#actualCPI').val(AddComma(cpiValue));
                    $('#cpiValue').val(AddComma(cpiValue + 1000));
                }
                if ($('#trapQuestion').find(':selected').index() == 2) {
                    // 검증문항에서 선택한 옵션이 2번일 경우 CPI에 1.1을 곱함 | If the selected option in the trap question is 2, multiply 1.1 to the CPI
                    $('.showActualCPI').text(AddComma(cpiValue));
                    $('#actualCPI').val(AddComma(cpiValue));
                    $('#cpiValue').val(AddComma(Math.round((cpiValue + Number.EPSILON) * 1.1)));
                } else if ($('#trapQuestion').find(':selected').index() == 3) {
                    // 검증문항에서 선택한 옵션이 3번일 경우 CPI에 1.2를 곱함 | If the selected option in the trap question is 3, multiply 1.2 to the CPI
                    $('.showActualCPI').text(AddComma(cpiValue));
                    $('#actualCPI').val(AddComma(cpiValue));
                    $('#cpiValue').val(AddComma(Math.round((cpiValue + Number.EPSILON) * 1.2)));
                }
                if ($('#trapQuestion').find(':selected').index() == 2 && ($('#specialPanel').find(':selected').index() == 2 || $('#specialPanel').find(':selected').index() == 3)) {
                    // 검증문항에서 선택한 옵션이 2번이고, 특수패널에서 선택한 옵션이 2번이거나 3번일 경우 CPI에 1.1를 곱하고 1000을 더함 | If the selected option in the trap question is 2 and in the Specific age grp is 2 or 3, multiply 1.1 and add 1000 to the CPI
                    $('.showActualCPI').text(AddComma(cpiValue));
                    $('#actualCPI').val(AddComma(cpiValue));
                    $('#cpiValue').val(AddComma(Math.round((cpiValue + Number.EPSILON) * 1.1) + 1000));
                } else if ($('#trapQuestion').find(':selected').index() == 3 && ($('#specialPanel').find(':selected').index() == 2 || $('#specialPanel').find(':selected').index() == 3)) {
                    // 검증문항에서 선택한 옵션이 2번이고, 특수패널에서 선택한 옵션이 2번이거나 3번일 경우 CPI에 1.2를 곱하고 1000을 더함 | If the selected option in the trap question is 2 and in the Specific age grp is 2 or 3, multiply 1.2 and add 1000 to the CPI
                    $('.showActualCPI').text(AddComma(cpiValue));
                    $('#actualCPI').val(AddComma(cpiValue));
                    $('#cpiValue').val(AddComma(Math.round((cpiValue + Number.EPSILON) * 1.2) + 1000));
                }
            }

        }
    }
  }

  /**
   * 이 기능은 다양한 조건과 사용자 입력을 기반으로 SOP_1 CPI 값을 자동으로 넣어줍니다. | This function handles the automatic filling of the SOP_1 CPI value based on various conditions and user inputs. 
   */
  function AutoFillSOP_1CPI(dataArray) {
    // 입력된 LOI 및 IR 값 가져오기 | Get the entered LOI and IR values
    var input_loi = parseInt($('#loiInput').val().replace(/,/g, ''), 10);
    var input_ir = parseInt($('#irInput').val().replace(/,/g, ''), 10);

    // 초기화할 변수들 | Variables to be initialized
    var val_cli = 3;
    var val_loi = 0;
    var val_ir = 0;

    if (isNaN(input_ir) || isNaN(input_loi)) {
        $('#sop_1CPI').val('');
        $('.showSOP_1CPI').text('');
    } else {
      // 입력된 LOI 값을 기반으로 단가표의 해당하는 LOI 범위의 index 값 설정 | Set the index value of the corresponding LOI range in the ratecard based on the entered LOI value.
      if (input_loi <= 5) { val_loi = 0; }
      if (input_loi >= 6 && input_loi <= 10) { val_loi = 1; }
      if (input_loi >= 11 && input_loi <= 15) { val_loi = 2; }
      if (input_loi >= 16 && input_loi <= 20) { val_loi = 3; }
      if (input_loi >= 21 && input_loi <= 25) { val_loi = 4; }
      if (input_loi >= 26 && input_loi <= 30) { val_loi = 5; }
      if (input_loi >= 31 && input_loi <= 35) { val_loi = 6; }
      if (input_loi >= 36 && input_loi <= 40) { val_loi = 7; }
      if (input_loi >= 41) { val_loi = 8; }

      // 입력된 IR 값을 기반으로 단가표의 해당하는 IR 범위의 index 값 설정 | Set the index value of the corresponding IR range in the ratecard based on the entered IR value. 
      if (input_ir >= 80) { val_ir = 0; }
      if (input_ir >= 60 && input_ir <= 79) { val_ir = 1; }
      if (input_ir >= 40 && input_ir <= 59) { val_ir = 2; }
      if (input_ir >= 30 && input_ir <= 39) { val_ir = 3; }
      if (input_ir >= 20 && input_ir <= 29) { val_ir = 4; }
      if (input_ir >= 15 && input_ir <= 19) { val_ir = 5; }
      if (input_ir >= 10 && input_ir <= 14) { val_ir = 6; }
      if (input_ir >= 8 && input_ir <= 9) { val_ir = 7; }
      if (input_ir >= 6 && input_ir <= 7) { val_ir = 8; }
      if (input_ir >= 5 && input_ir < 6) { val_ir = 9; }
      if (input_ir >= 4 && input_ir < 5) { val_ir = 10; }
      if (input_ir >= 3 && input_ir < 4) { val_ir = 11; }
      if (input_ir >= 2 && input_ir < 3) { val_ir = 12; }
      if (input_ir >= 0 && input_ir < 2) { val_ir = 13; }
    
      // 위에서 설정된 LOI & IR의 index 값을 기반으로 CPI 계산 | Calculate CPI value based on the previously set indices for LOI and IR
      var cpiValueSOP_1 = dataArray[val_cli][val_loi][val_ir];

      // 
      //var cpiValueSOP_1_KRW = Math.round(Number(cpiValueSOP_1.slice(1)) * krwRate);

      FlashBorder('#sop_1CPI');

      //console.log(cpiValueSOP_1_KRW);
      // CPI Comparison 부분에 SOP_1 CPI 보여줌 | show SOP_1 CPI in the CPI Comparison section
      $('.showSOP_1CPI').text(cpiValueSOP_1);
      $('#sop_1CPI').val(AddComma(cpiValueSOP_1)).trigger('change');
    }
  }

  /**
   * 이 기능은 다양한 조건과 사용자 입력을 기반으로 SOP_2 CPI 값을 자동으로 넣어줍니다. | This function handles the automatic filling of the SOP_2 CPI value based on various conditions and user inputs. 
   */
  function AutoFillSOP_2CPI(dataArray) {
    // 입력된 LOI 및 IR 값 가져오기 | Get the entered LOI and IR values
    var input_loi = parseInt($('#loiInput').val().replace(/,/g, ''), 10);
    var input_ir = parseInt($('#irInput').val().replace(/,/g, ''), 10);

    // 초기화할 변수들 | Variables to be initialized
    var val_cli = 4;
    var val_loi = 0;
    var val_ir = 0;

    if (isNaN(input_ir) || isNaN(input_loi)) {
        $('#sop_2CPI').val('');
        $('.showSOP_2CPI').text('');
    } else {
      // 입력된 LOI 값을 기반으로 단가표의 해당하는 LOI 범위의 index 값 설정 | Set the index value of the corresponding LOI range in the ratecard based on the entered LOI value.
      if (input_loi <= 5) { val_loi = 0; }
      if (input_loi >= 6 && input_loi <= 10) { val_loi = 1; }
      if (input_loi >= 11 && input_loi <= 15) { val_loi = 2; }
      if (input_loi >= 16 && input_loi <= 20) { val_loi = 3; }
      if (input_loi >= 21 && input_loi <= 25) { val_loi = 4; }
      if (input_loi >= 26 && input_loi <= 30) { val_loi = 5; }
      if (input_loi >= 31 && input_loi <= 35) { val_loi = 6; }
      if (input_loi >= 36 && input_loi <= 40) { val_loi = 7; }
      if (input_loi >= 41) { val_loi = 8; }

      // 입력된 IR 값을 기반으로 단가표의 해당하는 IR 범위의 index 값 설정 | Set the index value of the corresponding IR range in the ratecard based on the entered IR value. 
      if (input_ir >= 80) { val_ir = 0; }
      if (input_ir >= 60 && input_ir <= 79) { val_ir = 1; }
      if (input_ir >= 40 && input_ir <= 59) { val_ir = 2; }
      if (input_ir >= 30 && input_ir <= 39) { val_ir = 3; }
      if (input_ir >= 20 && input_ir <= 29) { val_ir = 4; }
      if (input_ir >= 15 && input_ir <= 19) { val_ir = 5; }
      if (input_ir >= 10 && input_ir <= 14) { val_ir = 6; }
      if (input_ir >= 8 && input_ir <= 9) { val_ir = 7; }
      if (input_ir >= 6 && input_ir <= 7) { val_ir = 8; }
      if (input_ir >= 5 && input_ir < 6) { val_ir = 9; }
      if (input_ir >= 4 && input_ir < 5) { val_ir = 10; }
      if (input_ir >= 3 && input_ir < 4) { val_ir = 11; }
      if (input_ir >= 2 && input_ir < 3) { val_ir = 12; }
      if (input_ir >= 0 && input_ir < 2) { val_ir = 13; }
    
      // 위에서 설정된 LOI & IR의 index 값을 기반으로 CPI 계산 | Calculate CPI value based on the previously set indices for LOI and IR
      var cpiValueSOP_2 = dataArray[val_cli][val_loi][val_ir];

      // 
      //var cpiValueSOP_1_KRW = Math.round(Number(cpiValueSOP_1.slice(1)) * krwRate);

      FlashBorder('#sop_2CPI');

      //console.log(cpiValueSOP_1_KRW);
      // CPI Comparison 부분에 SOP_2 CPI 보여줌 | show SOP_2 CPI in the CPI Comparison section
      $('.showSOP_2CPI').text(cpiValueSOP_2);
      $('#sop_2CPI').val(AddComma(cpiValueSOP_2)).trigger('change');
    }
  }

  /**
   * 이 기능은 quotation form을 제출하기 전에 유효성을 검사합니다. | This function validates the quotation form before submission.
   */
  function ValidateForm() {

    // 폼이 유효하지 않은지 확인하기 위한 변수 초기화 | Initialize variable to check if the form is not valid
    var formInvalid = false;

    // 필수 속성이 설정된 가시(input, select, textarea) 엘리먼트를 필터링하고 각각에 대해 확인 | Filter visible (input, select, textarea) elements with required attribute and check each one
    $('#quoteForm input, #quoteForm select, #quoteForm textarea').filter('[required]:visible').each(function() {
      // 값이 비어있는 경우 폼이 유효하지 않음을 표시하는 변수를 true로 설정 | Set the variable indicating the form is not valid to true if the value is empty
      if ($(this).val() === '') {
        formInvalid = true;
      }
    });

    console.log(formInvalid);

    // 폼이 유효하지 않은 경우 | If the form is not valid
    if (formInvalid) {
      // 현재 언어에 따라 메시지 설정 | Set the message based on the current language
      if (lang == "ko" || lang == "") {
        $('#alertMessage').text('필수항목을 모두 입력해주세요.');
      }
      if (lang == "en") {
        $('#alertMessage').text('Please fill out all required fields.');
      }

      // 경고 모달 표시 | Show the warning modal
      $modal = $('#warningAlert');
      $modal.modal('show');

      // was-validated 클래스 추가하여 유효성 검사 상태를 나타냄 | Add the was-validated class to indicate the validation state
      //$('#quoteForm').addClass('was-validated');
    } else {
      // // 확인 메시지를 표시하고 사용자가 RFQ를 제출하려는지 확인 | Display a confirmation message and confirm if the user wants to submit the RFQ
      // if (confirm('Are you sure you want to ' + $('#formType').val() + ' this RFQ?')) {
      //   // 숨겨진 필드를 채우고 폼 제출 | Fill hidden fields and submit the form
      //   FillHidden();
      //   // was-validated 클래스 제거하여 유효성 검사 상태를 초기화 | Remove the was-validated class to reset the validation state
      //   $('#quoteForm').removeClass('was-validated');
      //   $('#quoteForm').submit();
      // }

      // 확인 메시지를 표시하고 사용자가 RFQ를 제출하려는지 확인 | Display a confirmation message and confirm if the user wants to submit the RFQ
      if(lang == "ko" || lang == "") {
        $('#confirmMessage').text($('#formType').val() === 'export' ? '이 RFQ를 내보내시겠습니까?' : $('#formType').val() === 'save-export' ? '이 RFQ를 저장 및 내보내시겠습니까?' : $('#formType').val() === 'update' ? '이 RFQ를 업데이트 하시겠습니까?' : $('#formType').val() === 'save-draft' ? '이 RFQ를 임시 저장 하시겠습니까?' : '이 RFQ를 저장 하시겠습니까?');
      }
      if(lang == "en") {
        const msgType = $('#formType').val() === 'save-export' ? 'save and export' : $('#formType').val() === 'save-draft' ? 'save' : $('#formType').val();
        const msgDraft = $('#formType').val() === 'save-draft' ? ' as draft' : '';
        $('#confirmMessage').text(`Are you sure you want to ${msgType} this RFQ${ msgDraft }?`);
      }

      $modal = $('#confirmAlert');
      $modal.find('button.modal-alert-btn-confrim').text($('#formType').val() === 'export' ? 'Export' : $('#formType').val() === 'save-export' ? 'Save & Export' : $('#formType').val() === 'update' ? 'Update' : 'Save');

      $modal.modal('show');

      $modal.find('button.modal-alert-btn-confrim').on('click', function(){
        // 숨겨진 필드를 채우고 폼 제출 | Fill hidden fields and submit the form
        FillHidden();
        // was-validated 클래스 제거하여 유효성 검사 상태를 초기화 | Remove the was-validated class to reset the validation state
        //$('#quoteForm').removeClass('was-validated');
        $('#quoteForm').submit();
      });
    }
  }

  /**
   * 견적, 프로핏, 순수익 등 자동으로 계산되어서 hidden input에 넣어줍니다. | Expected sales, GM(%), GM, and other values are automatically calculated and placed into hidden inputs.
   */
  function FillHidden() {
    

    if(rfqMode == 'KR') {
      var possibleNum = parseInt($('#possibleNum').val().replace(/,/g , ''),10);
      var sampleNum = parseInt($('#sampleNum').val().replace(/,/g , ''),10);
      var irInput = parseInt($('#irInput').val().replace(/,/g , ''),10);
      var compPt = parseInt($('#compPt').val().replace(/,/g , ''),10);
      var cpiValue = parseInt($('#cpiValue').val().replace(/,/g , ''),10);
      var webupCost = $('#webupCost').val() === "" ? 0 : parseInt($('#webupCost').val().replace(/,/g , ''),10);
      var operationCost = $('#operationCost').val() === "" ? 0 : parseInt($('#operationCost').val().replace(/,/g , ''),10);
      var thirdpartyCost_1 = $('#3rdpartyCost_1').val() === "" ? 0 : parseInt($('#3rdpartyCost_1').val().replace(/,/g , ''),10);
      var thirdpartyCost_2 = $('#3rdpartyCost_2').val() === "" ? 0 : parseInt($('#3rdpartyCost_2').val().replace(/,/g , ''),10);
      var thirdpartyCost_3 = $('#3rdpartyCost_3').val() === "" ? 0 : parseInt($('#3rdpartyCost_3').val().replace(/,/g , ''),10);
      var sop_1Cost = $('#sop_1Cost').val() === "" ? 0 : parseInt($('#sop_1Cost').val().replace(/,/g , ''),10);
      var sop_2Cost = $('#sop_2Cost').val() === "" ? 0 : parseInt($('#sop_2Cost').val().replace(/,/g , ''),10);
      var input_loi = $('#loiInput').val();
      var input_ir = $('#irInput').val();
      var select_client = $('#clientSelect').val();
    
      //클라이언트 그룹 | client group
      $('#selectedGroup').val($('#clientSelect').find(':selected').parent().attr('label'));

      //SC 개수 계산 | calculates SC
      $('#scCount').val(Math.round((possibleNum * (100 - irInput)) / irInput));
      var scCount = parseInt($('#scCount').val().replace(/,/g , ''),10);

      //QF 개수 계산 | calculates QF
      $('#qfCount').val(Math.round(scCount / 5));
      var qfCount = parseInt($('#qfCount').val().replace(/,/g , ''),10);

      //총 파트너비용 계산 | calculates total 3rd party costs
      $('#totalPartnerCost').val(thirdpartyCost_1 + thirdpartyCost_2 + thirdpartyCost_3);
      var totalPartnerCost = parseInt($('#totalPartnerCost').val().replace(/,/g , ''),10);

      //총 SOP 계산 | calculates total SOP costs
      $('#totalSOPCost').val(sop_1Cost + sop_2Cost);
      var totalSOPCost = parseInt($('#totalSOPCost').val().replace(/,/g , ''),10);

      //포인트비용 계산 | calculates point fee
      $('#ptCost').val((compPt * possibleNum) + (scCount * 50) + (qfCount * 50));
      var ptCost = parseInt($('#ptCost').val().replace(/,/g , ''),10);

      //견적 계산 | calculates expected sales
      if($('input[name="Calculation method"]:checked').val() == 'Requested N'){
        $('#quoteEstimate').val((sampleNum * cpiValue) + webupCost + operationCost);
      }
      if($('input[name="Calculation method"]:checked').val() == 'dS Feasible N'){
        $('#quoteEstimate').val((possibleNum * cpiValue) + webupCost + operationCost);
      }
      var quoteEstimate = parseInt($('#quoteEstimate').val().replace(/,/g , ''),10);

      //프로핏 계산 | calculates GM(%)
      var num = (quoteEstimate - ((totalPartnerCost + totalSOPCost) + (ptCost * 1))) / quoteEstimate;
      $('#profitRate').val(((num) * 100).toFixed(2));
      //console.log($('#profitRate').val());

      //순수익 계산 | calculates GM
      $('#netIncome').val(quoteEstimate - ((ptCost * 1) + (totalPartnerCost + totalSOPCost)));
      //console.log($('#netIncome').val());

      //선택된 운영비 항목 | selected other fee options
      var arrOther = [];
      $('.checkbox-option').each(function(index){
        if($(this).is(':checked')) {
          arrOther.push($(this).val());
        }
      });
      $('#otherFee').val(arrOther.join(","));
    }

    if(rfqMode == 'OS') {
      var country_code_list = [];
      var country_list = [];
      var export_form_list = [];
      var totalOverlayFee = 0;
      var totalOperationFee = 0;
      var totalFeasibility = 0;
      var totalOverlayCnt = 0;
      var totalOperationCnt = 0;

      $('.select-country-btn').each(function(){
        var country_code = $(this).attr('data-bs-target').split('#v-pills-')[1];
        var country_name = countryListOptions.find(item => country_code.split('-')[0] === item.id.split('-')[0].toLowerCase()).text;
        var country_name_kr = countryListOptions.find(item => country_code.split('-')[0] === item.id.split('-')[0].toLowerCase()).text_kr;

        country_code_list.push(country_code);
        country_list.push(country_name);
        $('#countryRename-'+country_code).val($(this).nextAll('.select-country-text').val());
        $('#countryName-' + country_code).val(country_name);
        $('#countryNameKr-' + country_code).val(country_name_kr);
      });
      $('#countryCodeList').val(country_code_list);
      $('#countryList').val(country_list);

      $('#hidden_totalProgrammingFee').val($('#finalProgramming').val());

      $('[id^=overlayCost-]').each(function () {
          if($(this).val() !== '') totalOverlayCnt++;
          //totalOverlayFee += Number($(this).val().replace(/,/g , ''));
      });
      // $('#hidden_totalOverlayFee').val(totalOverlayFee === 0 ? '' : AddComma(totalOverlayFee));
      $('#hidden_totalOverlayFee').val($('#finalOverlay').val());

      $('[id^=operationCost-]').each(function () {
          if($(this).val() !== '') totalOperationCnt++;
          //totalOperationFee += Number($(this).val().replace(/,/g , ''));
      });
      // $('#hidden_totalOtherFee').val(totalOperationFee === 0 ? '' : AddComma(totalOperationFee));
      $('#hidden_totalOtherFee').val($('#finalOther').val());

      $('[id^=totalVendorFeasibility-]').each(function () {
          totalFeasibility += Number($(this).val().replace(/,/g , ''));
      });
      $('#hidden_totalFeasibility').val(totalFeasibility === 0 ? '' : AddComma(totalFeasibility));

      $('#hidden_totalSales').val($('#finalSales').val());

      $('#hidden_totalGM').val($('#finalGM').val());

      $('#hidden_totalGMPer').val($('#finalGMPer').val());

      export_form_list.push($('[id^=clientSelect-]').eq(0).val());
      export_form_list.push($('[id^=picName-]').eq(0).val());
      export_form_list.push($('[id^=managerSelect-]').eq(0).val());
      export_form_list.push($('#hidden_totalFeasibility').val());
      export_form_list.push($('[id^=loiInput-]').eq(0).val());
      export_form_list.push($('#hidden_totalProgrammingFee').val());
      export_form_list.push(totalOverlayCnt === 0 ? '' : totalOverlayCnt);
      export_form_list.push($('#hidden_totalOverlayFee').val());
      export_form_list.push(totalOperationCnt === 0 ? '' : totalOperationCnt);
      export_form_list.push($('#hidden_totalOtherFee').val());
      export_form_list.push($('[id^=projectName-]').eq(0).val());
      export_form_list.push($('[id^=targetCondition-]').eq(0).val());
      $('#exportFormList').val(export_form_list.join('||'));

    }
  }

  /**
   * SC, QF, 포인트 비용, 견적, GM 등을 자동으로 계산하여 'Calculated quotation' 부분의 테이블에 행을 추가함 | Automatically calculate SC, QF, point fee, expected sales, GM, etc., and add a row to the 'Calculated quotation' section's table.
   */
  function AppendCalculatedResult() {
    // 변수 초기화 | Initialize variables
    var scCount = $('#scCount').val();
    var qfCount = $('#qfCount').val();
    var ptCost = $('#ptCost').val();
    var totalPartnerCost = $('#totalPartnerCost').val();
    var totalSOPCost = $('#totalSOPCost').val();
    var cpiValue = $('#cpiValue').val();
    var quoteEstimate = $('#quoteEstimate').val();
    var profitRate = $('#profitRate').val();
    var netIncome = $('#netIncome').val();

    // 계산 결과 배열에 현재 상태 저장 | Save the current state to the calculation result array
    calcResultArray.push($('#quoteForm').serializeArray());

    // 계산 결과를 테이블에 추가 | Append the calculation result to the table
    $('#calcResultTable tbody').append('<tr><th scope="row">'+calcRowCnt+'</th><td>'+AddComma(cpiValue)+'</td><td>'+AddComma(scCount)+'</td><td>'+AddComma(qfCount)+'</td><td>'+AddComma(totalPartnerCost)+'</td><td>'+AddComma(totalSOPCost)+'</td><td>'+AddComma(ptCost)+'</td><td>'+AddComma(quoteEstimate)+'</td><td class="profit-rate-td">'+profitRate+'%</td><td>'+AddComma(netIncome)+'</td></tr>');

    // 이익률이 60% 미만인 경우 경고 스타일 추가 | Add warning style if profit rate is less than 60%
    $('.profit-rate-td').each(function(index){
      if(parseInt($(this).text().slice(0, -1),10) < 60){
        $(this).addClass('warn-red');
      }
    });

    // 이익률이 60% 미만인 경우 경고 메시지 표시 | Display warning message if profit rate is less than 60%
    if(parseInt(profitRate,10) < 60) {
      if(lang == "ko" || lang == "") {
        $('#alertMessage').text('GM이 60% 미만입니다. TL과 상의 해주세요.');
      }
      if(lang == "en") {
        $('#alertMessage').text('GM is below 60%. Please consult with your TL.');
      }

      $modal = $('#warningAlert');
      $modal.modal('show');
    } 

    // 테이블 행을 클릭할 때 이벤트 설정 | Set events when clicking on a table row
    $('#calcResultTable tbody tr').off('click').on('click',function(){
      var index = $(this).index();
      var actualCPI = 0;
      // var sop_1CPI = 0;
      // var sop_2CPI = 0;
      $('.checkbox-option').each(function(index){
        $(this).prop('checked',false);
      });
      $('input[name="Calculation method"][value="Requested N"]').prop('checked',false);
      $('input[name="Calculation method"][value="dS Feasible N"]').prop('checked',false);

      // 계산 결과 배열에서 값 가져오기 | Retrieve values from the calculation result array
      var partnerExist = false;
      var partnerBoxCnt;
      var sopExist = false;
      //console.log(calcResultArray);
      calcResultArray[index].forEach(function (pair) {
        var selector = `input[name="${ pair.name }"], select[name="${ pair.name }"]`;
        var input = $('#quoteForm').find(selector).not('input[type="radio"]');
        input.val(pair.value);

        // 실제 CPI 값 저장 | Save the actual CPI value
        if(pair.name == "Actual CPI"){
          actualCPI = pair.value;
        }

        // 운영비 옵션 처리 | Handle other fee options
        if(pair.name == "Other fee options"){
          if(pair.value !== ''){
            $('#otherFeeSwitch').prop('checked',true);
            $('#otherFeeBox').show();
            pair.value.split(',').forEach(function(item){
              $('.checkbox-option').each(function(index){
                if($(this).val() == item){
                  $(this).prop('checked',true);
                }
              });
            });
          }else{
            $('#otherFeeSwitch').prop('checked',false);
            $('#otherFeeBox').hide();
          }
        }

        if (pair.name == "SOP_1 Costs") {
          if (pair.value !== '') {
            $('#sopSOP_1').prop('checked',true);
            //$('#sopUseBoxInput').children().eq(0).show();
            $('#sop_1UseBoxInput').show();
          } else {
            $('#sopSOP_1').prop('checked',false);
            //$('#sopUseBoxInput').children().eq(0).hide();
            $('#sop_1UseBoxInput').hide();
          }
        }

        if (pair.name == "SOP_2 Costs") {
          if (pair.value !== '') {
            $('#sopSOP_2').prop('checked',true);
            //$('#sopUseBoxInput').children().eq(0).show();
            $('#sop_2UseBoxInput').show();
          } else {
            $('#sopSOP_2').prop('checked',false);
            //$('#sopUseBoxInput').children().eq(0).hide();
            $('#sop_2UseBoxInput').hide();
          }
        }

        // 계산 방법 처리 | Handle calculation method
        if(pair.name == "Calculation method"){
          $('input[name="Calculation method"][value="' + pair.value + '"]').prop('checked',true);
        }

        // 3rd party Usage 처리 | Handle 3rd party Usage
        if(pair.name == "3rd party Usage"){
          if(pair.value == 'on'){
            $('#partnerUseSwitch').prop('checked',true);
            $('#partnerUseBoxCnt').parent().show();
            partnerExist = true;
          }
        }

        if(pair.name == "SOP Usage"){
          if(pair.value == 'on'){
            sopExist = true;
          }
        }

        // 3rd party Usage count 처리 | Handle 3rd party Usage count
        if(pair.name == "3rd party Usage count"){
          partnerBoxCnt = pair.value;
        }
      });

      // 파트너 사용 여부에 따라 UI 갱신 | Update UI based on partner usage
      if(partnerExist == false){
        $('#partnerUseSwitch').prop('checked',false);
        $('#partnerUseBox').children().hide();
        $('#partnerUseBoxCnt').parent().hide();
        $('#partnerUseBox').removeClass('partnerusebox-bottom-margin');
      } else {
        $('#partnerUseBox').addClass('partnerusebox-bottom-margin');
        if(partnerBoxCnt == '1'){
          $('#partnerUseBox').children().eq(0).show();
          $('#partnerUseBox').children().eq(1).hide();
          $('#partnerUseBox').children().eq(2).hide();
        }
        if(partnerBoxCnt == '2'){
          $('#partnerUseBox').children().eq(0).show();
          $('#partnerUseBox').children().eq(1).show();
          $('#partnerUseBox').children().eq(2).hide();
        }
        if(partnerBoxCnt == '3'){
          $('#partnerUseBox').children().eq(0).show();
          $('#partnerUseBox').children().eq(1).show();
          $('#partnerUseBox').children().eq(2).show();
        }
      }

      if(sopExist == false) {
        $('#sopUseSwitch').prop('checked', false);
        $('#sopUseBox').hide();
      } else {
        $('#sopUseSwitch').prop('checked', true);
        $('#sopUseBox').show();
      }

      // 이전 선택 값 저장 | Save previous selected values
      previousS = $("#specialPanel").prop('selectedIndex');
      previousT = $("#trapQuestion").prop('selectedIndex');
      
      // 실제 CPI 값 표시 및 새로고침 | Display actual CPI value and refresh selectpicker
      $('.showActualCPI').text(AddComma(actualCPI));

      
      $('.selectpicker').selectpicker('refresh');

      // 선택한 행에 활성화 클래스 추가 및 다른 행에서 제거 | Add activated class to the selected row and remove from other rows
      $(this).addClass('activated');
      $('#calcResultTable tbody tr').not(':eq('+ index.toString() +')').removeClass('activated');
    });

    // 행 번호 숫자 증가 | Increase row number
    calcRowCnt++;
  }

  /**
   * 요청 샘플수/dS 가능수, CPI, 운영비 및 웹업비를 기반으로 견적비의 예상 총 비용을 자동으로 계산하고 견적 테이블에 기입합니다. | Automatically calculates estimated total quotation cost based on Requested N/dS Feasible N, CPI, Other fee, and Programming fee, and fills in the Quote table.
   */
  function FillQuoteTable() {
    // 변수 초기화 | Initialize variables
    var possibleNum = parseInt($('#possibleNum').val().replace(/,/g , ''), 10);
    var sampleNum = parseInt($('#sampleNum').val().replace(/,/g , ''), 10);
    var cpiValue = parseInt($('#cpiValue').val().replace(/,/g , ''), 10);
    var webupCost = $('#webupCost').val() === "" ? 0 : parseInt($('#webupCost').val().replace(/,/g , ''), 10);
    var operationCost = $('#operationCost').val() === "" ? 0 : parseInt($('#operationCost').val().replace(/,/g , ''), 10);
    var ppCost = sampleNum * cpiValue;
    var quoteEstimate = parseInt($('#quoteEstimate').val().replace(/,/g , ''), 10);
    var quoteEstimateTax = Math.round((quoteEstimate + Number.EPSILON) * 1.1);

    // 견적 테이블의 각 행의 span 요소 찾기 | Find span elements of each row in the quote table
    var row1 = $('.quoteRow1').children().find('span');
    var row2 = $('.quoteRow2').children().find('span');
    var row3 = $('.quoteRow3').children().find('span');
    var row4 = $('.quoteRow4').children().find('span');
    var row5 = $('.quoteRow5').children().find('span');

    // 웹업 비용이 0이고 테이블 행이 5개인 경우 행 숨기기 | Hide row if webup cost is 0 and the table has 5 rows
    if (webupCost == 0 && $('#quoteTable tbody tr').length == 5) {
      row1.parent().parent().hide();
    } else {
      row1.parent().parent().show();
    }

    // 웹업 비용 정보 설정 | Set webup cost information
    row1.eq(1).text($('#webupCost').val() === "" ? "" : "1");
    row1.eq(2).text($('#webupCost').val() === "" ? "" : AddComma(webupCost));
    row1.eq(3).text(AddComma(webupCost));

    // 계산 방법에 따라 행2의 정보 설정 | Set information in row 2 based on the calculation method
    if ($('input[name="Calculation method"]:checked').val() == 'Requested N') {
      row2.eq(1).text(AddComma(sampleNum));
    }
    if ($('input[name="Calculation method"]:checked').val() == 'dS Feasible N') {
      row2.eq(1).text(AddComma(possibleNum));
      ppCost = possibleNum * cpiValue;
    }
    row2.eq(2).text(AddComma(cpiValue));
    row2.eq(3).text(AddComma(ppCost));

    // 운영 비용이 0이고 테이블 행이 5개인 경우 행 숨기기 | Hide row if operation cost is 0 and the table has 5 rows
    if (operationCost == 0 && $('#quoteTable tbody tr').length == 5) {
      row3.parent().parent().hide();
    } else {
      row3.parent().parent().show();
    }
    // 운영 비용 정보 설정 | Set operation cost information
    row3.eq(1).text($('#operationCost').val() === "" ? "" : "1");
    row3.eq(2).text($('#operationCost').val() === "" ? "" : AddComma(operationCost));
    row3.eq(3).text(AddComma(operationCost));

    // 견적 금액 정보 설정 | Set quote estimate information
    row4.eq(1).text(AddComma(quoteEstimate));

    // 세금 포함 견적 정보 설정 | Set quote estimate with tax information
    row5.eq(1).text(AddComma(quoteEstimateTax));
  }

  /**
   * RFQ 폼이 submit 된 후, 성공/실패 메세지 보여줌 | Show success/fail message after the RFQ form has been submitted
   */
  function handleFormSubmit(formObject) {    
    // 버튼 비활성화 및 로딩 스피너 표시 | Disable button and show loading spinner
    // $('#' + $('#formType').val() + 'All').prop('disabled', true);
    // $('#' + $('#formType').val() + 'All').addClass('btn-disabled');
    // $('#' + $('#formType').val() + 'All .spinner').addClass('spinner-busy');

    $('.main-save-btn').prop('disabled', true);
    $('.main-save-btn').addClass('btn-disabled');
    $('.main-save-btn .spinner').addClass('spinner-busy');


    // Google 스크립트 실행 | Execute Google script
    google.script.run
        .withFailureHandler(e => {
          // 실패 시 오류 메시지 표시 | Display error message on failure
          $('.fail-error-message').text(e.message);

          // 버튼 활성화 및 로딩 스피너 숨김 | Enable button and hide loading spinner
          // $('#' + $('#formType').val() + 'All').prop('disabled', false);
          // $('#' + $('#formType').val() + 'All').removeClass('btn-disabled');
          // $('#' + $('#formType').val() + 'All .spinner').removeClass('spinner-busy');

          $('.main-save-btn').prop('disabled', false);
          $('.main-save-btn').removeClass('btn-disabled');
          $('.main-save-btn .spinner').removeClass('spinner-busy');

          // 실패 메세지 표시 | Display failure message
          $('#failToast').toast('show');
        })
        .withSuccessHandler(e => {
          // 성공 시 알림 메시지 설정 | Set success alert message on success
          $('#successAlertType1').text($('#formType').val() === 'export' ? 'Exporte' : $('#formType').val() === 'save-export' ? 'Saved & Exporte' : $('#formType').val() === 'save-draft' ? 'Draft save' : $('#formType').val().charAt(0).toUpperCase() + $('#formType').val().slice(1));
          $('#successAlertType2').text($('#formType').val() === 'export' ? $('#formType').val() + 'e' : $('#formType').val() === 'save-export' ? 'saved and exporte' : $('#formType').val() === 'save-draft' ? 'save' : $('#formType').val());
          if($('#formType').val() === 'export' || $('#formType').val() === 'save-export') {
            $('#successAlertType3').show();
          } else {
            $('#successAlertType3').hide();
          }

          // 버튼 활성화 및 로딩 스피너 숨김 | Enable button and hide loading spinner
          // $('#' + $('#formType').val() + 'All').prop('disabled', false);
          // $('#' + $('#formType').val() + 'All').removeClass('btn-disabled');
          // $('#' + $('#formType').val() + 'All .spinner').removeClass('spinner-busy');

          $('.main-save-btn').prop('disabled', false);
          $('.main-save-btn').removeClass('btn-disabled');
          $('.main-save-btn .spinner').removeClass('spinner-busy');
          
          // 성공 메세지 표시 | Display success message
          $('#successToast').toast('show');

          //console.log(formObject);
          
        })
        .doPost(formObject);
  }

  /**
   * 세 자릿수마다 쉼표를 추가하여 큰 숫자를 더 가독성 있게 만듭니다. | Adds comma every third digit to make big numbers more readable. 
   */
  function AddComma(number) {
    var parts = typeof number === 'string' ? number.split(".") : number.toString().split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return parts.join(".");
  }

  /**
   * 숫자가 자동으로 계산될 때 입력 테두리가 깜박이게 하여 사용자가 숫자가 변경되었음을 알 수 있도록 합니다. | Flashes input border when numbers are automatically calculated, so that users can know that the numbers changed.
   */
  function FlashBorder(selector) {
    $(selector).removeClass("flash-border");
    $(selector).width(); // trigger a DOM reflow
    $(selector).addClass("flash-border");
  }

  function RefreshDatePicker(selector,date) {
    $(selector).daterangepicker({
        "singleDatePicker": true,
        "startDate": date,
        "maxDate": endDate,
        "locale": {
            "format": "M/D/YYYY"
        }
    });
  }

  

</script>